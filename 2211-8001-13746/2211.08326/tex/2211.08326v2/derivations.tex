\section{Derivations}

We make the hypothesis that we only have weakly  attributes $y$. If they are discrete, we could say that one sample $x_k$ would be considered positive only if it has exactly the same attribute of the anchor (i.e., $y=y_k$). Otherwise it is considered as a negative. In that case, we would obtain exactly SupCon:

\begin{equation}
        s_t - s_k \leq 0 \quad  \text{ if } w_k=\delta(y-y_k)=1 \quad \forall k,t \neq k        
\end{equation}

If we define as negatives the samples that have a different attribute than the one of the anchor and positives the ones that have the same attribute, we retrieve: 

\begin{equation}
    s^-_j - s^+_i \leq 0 \quad \forall i,j \quad \text{ and } \quad s^+_t - s^+_i \leq 0 \quad \forall i,t \neq i
    \label{eq:supcon-condition-full}
\end{equation}

Exactly as in the ICLR paper.
This can be translated as an optimization problem using:


\begin{align}
    \argmin_f \sum_k w_k \max(0, \{ s_t - s_k \}_{\substack{t=1,...,N \\ t \neq k}})\\ \approx \argmin_f \left[ \sum_k w_k \log \left( \exp(0) + \sum_{t \neq k} \exp(s_t - s_k)\right) \right]    
\end{align}

\begin{equation}
\setlength{\jot}{15pt}
\begin{aligned}
  &\approx \sum_k w_k \log \left( \exp(0) + \sum_{t \neq k} \exp(s_t - s_k) \right) \\
    & = \sum_k w_k \log \left( 1 + \frac{\sum_{t \neq k} \exp(s_t)}{\exp(s_k)} \right) \\
    & = \sum_k w_k \log \left( \frac{ \exp(s_k) + \sum_{t \neq k} \exp(s_t)}{\exp(s_k)}  \right) \\
    &= - \sum_k w_k \log \left( \frac{\exp(s_k)}{\exp(s_k) + \sum_{t \neq k} \exp(s_t)}  \right) \\
    &= - \sum_k w_k \log \left( \frac{\exp(s_k)}{\sum_{t=1}^N \exp(s_t)}  \right)
\end{aligned}
\end{equation}

In the MICCAI paper we have made the hypothesis that

\begin{equation}
        s_t - s_k \leq 0 \quad  \text{ if } \frac{w_k}{\sum_j w_j} \neq 0 \quad \forall j,k,t \neq k        
\end{equation}

\begin{align}
    \sum_k \frac{w_k}{\sum_t w_t} \max(0, \{ s_t - s_k \}_{\substack{t=1,...,N \\ t \neq k}}) \\ \approx  - \sum_k \frac{w_k}{\sum_t w_t} \log \left( \frac{\exp(s_k)}{\sum_{t=1}^N \exp(s_t)}  \right)
\end{align}

%
\begin{equation}
    - \sum_k \delta_{\frac{w_k}{\sum_t w_t} > 0} \log \left( \frac{\exp(s_k)}{\sum_{t=1}^N \exp(s_t)}  \right)
\end{equation}

\subsection{Analysis of $\mathcal{L}^{thr}$}

But in reality, we would like to optimize:

\begin{equation}
        s_t - s_k \leq 0 \quad  \text{ if } w_t - w_k \leq 0 \text{ and } w_k \neq 0 \quad \forall k,t \neq k        
\end{equation}

%

\begin{equation}
\begin{aligned}
    \mathcal{L}^{thr}_i &= - \sum_k \frac{w_k}{\sum_t \delta_{w_t < w_k} w_t} \log \left( \frac{\exp(s_k)}{\sum_{t=1}^N \delta_{w_t < w_k} \exp(s_t)}  \right) \\
    &= \sum_k \frac{w_k}{?}\left[\log\exp(-s_k) + \log\left(\sum_{t=1}^N \delta_{w_t < w_k} \exp(s_t) \right)\right] \\
    &= \sum_k \frac{w_k}{?}\log\left(\exp(-s_k)\sum_{t=1}^N \delta_{w_t < w_k} \exp(s_t) \right) \\
    &= \sum_k \frac{w_k}{?} \log\left(\sum_{t=1}^N \delta_{w_t < w_k} \exp(s_t - s_k) \right) \\
    &\approx \sum_k \frac{w_k}{?} \max(0, \{s_t - s_k\}_{w_t < w_k})
\end{aligned}
\end{equation}


\noindent  meaning that given an anchor $z_i$ and a sample $z_k$ we want to maximize the margin between $z_k$ and the closest sample $z_j$ which is ``more negative'' than $z_k$. %

%


I don't think that $w$ needs to be an actual kernel so I removed the normalization. 
This means that, during optimization, for each sample $k$ we should first look whether $w_k \neq 0$, so if the attributes of the sample $k$ and the anchor are similar according to the similarity function (or kernel) $w$. Then, we should create the negatives samples $t$ by looking at the samples in the batch that have $w_t - w_k \leq 0$. Other solutions are possible of course !

\subsection{Analysis of $\mathcal{L}^{exp}$}

\begin{equation}
\begin{aligned}
    \mathcal{L}^{exp} &= -\frac{1}{\sum_t w_t}\sum_{k}w_k \log \frac{\exp(s_k)}{\sum_{t \neq k} \exp(s_t(1-w_t))} \\
    &= \frac{1}{\sum_t w_t}\sum_{k}w_k \left[\log\exp(-s_k) + \log\sum_{t \neq k}\exp(s_t(1-w_t))\right] \\
    &= \frac{1}{\sum_t w_t}\sum_{k}w_k \log\left(\exp(-s_k)\sum_{t \neq k}\exp(s_t(1-w_t)) \right) \\
    &= \frac{1}{\sum_t w_t}\sum_{k}w_k \log\left(\sum_{t \neq k}\exp(s_t(1-w_t) - s_k) \right) \\
    &\approx \frac{1}{\sum_t w_t}\sum_{k}w_k \max(0, \{s_t(1-w_t) - s_k\}) \\
    & s_t(1-w_t) - s_k \leq 0  \quad  \text{ if } w_k > 0
\end{aligned}
\end{equation}
%

%


We make the hypothesis there is just one $k$ and one $t$
\begin{equation}
\begin{aligned}
& w_k(s_t - s_k)\leq 0 \quad w_k \geq 0 \\ 
& \argmin_f \max(0, \{ w_k (s_t - s_k) \}=\argmin_f w_k \max(0, \{(s_t - s_k) \}\\ 
& \approx \argmin_f \log \left( \exp(0) +  \exp( w_k (s_t - s_k))\right) = \log \left( \exp(0) +  \exp(s_t - s_k)^{w_k} \right)\neq\\
& \approx \argmin_f w_k \log \left( \exp(0) +  \exp(s_t - s_k)\right)
\end{aligned}
\end{equation}

Without the $\exp(0)$, it would be the same. 

\noindent %
\begin{equation}
\begin{aligned}
    \argmin_f \log \left( \exp(0) + \exp( w_k (s_t - s_k))\right) \\
    = \argmin_f \log \left(\exp(0) + \frac{\exp(w_k s_t)}{\exp(w_k s_k)}\right)\\
    = \argmin_f \log \left(\frac{\exp(w_k s_k) + \exp(w_k s_t)}{\exp(w_k s_k)}\right) \\
    = \argmin_f - \log \left(\frac{\exp(w_k s_k)}{\exp(w_k s_k) + \exp(w_k s_t)} \right) \\
    = \argmin_f - \log \left(\frac{\exp(s_k)^{w_k}}{\exp(s_k)^{w_k} + \exp(s_t)^{w_k}} \right) \\
    = \argmin_f - \left[\log\exp(s_k)^{w_k} - \log(\exp(s_k)^{w_k} + \exp(s_t)^{w_k}) \right] \\
\end{aligned}
\end{equation}


If I add the sum over the t within the log, is even more different

\begin{equation}
\begin{aligned}
& w_k(s_t - s_k)\leq 0 \quad w_k \geq 0 \forall k,t \\ 
& \argmin_f \sum_k \max(0, \{ w_k (s_t - s_k) \})_{t=1,...,N}=\argmin_f \sum_k w_k \max(0, \{(s_t - s_k) \})_{t=1,...,N}\\ 
& \approx \argmin_f \sum_k \log \left( \exp(0) + \sum_t \exp(s_t - s_k)^{w_k}\right) \neq\\
& \approx \argmin_f \sum_k w_k \log \left( \exp(0) + \sum_t \exp(s_t - s_k)\right)
\end{aligned}
\end{equation}
