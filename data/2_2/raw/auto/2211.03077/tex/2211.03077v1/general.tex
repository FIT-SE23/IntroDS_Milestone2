\subsection{Algorithm with a Known Upper Bound of the Impartiality Ratio}
\label{sec:greedy-reduction-bounded}

Suppose that we are given an upper bound $\mu$ of the instance's impartiality ratio $\mu^*$.
In other words, we know that the instance is $\mu$-impartial.
%Suppose that the instance is $\mu$-impartial, 
For any item $t$, let $\bar{v}_t=\max_{i\in[N]}v_{it}$ denote the maximum value of any agent for item $t$. 
By Lemma \ref{lem:maximum-mu-value}, we should only allocate item $t$ to the agents whose values for item $t$ is at least $\frac{1}{\mu}\bar{v}_t$.
A na√Øve approach is to treat all such agents as if they had value $\bar{v}_t$ for the item, and 
then apply the Myopic Greedy algorithm;
doing so would lose an extra factor $\mu$ in the competitive ratio in the worst case.
Instead, we divide the item equally into $\lceil \log \mu \rceil$ sub-items, each with supply $\frac{s_t}{\lceil \log \mu \rceil}$.
For the $j$-th sub-item, which we referred to as sub-item $(t, j)$, the agents' values are rounded down to either $\frac{\bar{v}_t}{2^j}$ or $0$.
That is, an agent $i$ has value $\frac{\bar{v}_t}{2^j}$ for sub-item $(t, j)$ if its original value for item $t$ is at least as much, and has value $0$ for this sub-item otherwise.
Then, we run the Myopic Greedy algorithm to allocate the sub-items.
See Algorithm~\ref{alg:greedy-reduction-mu} for a formal definition.

\begin{algorithm}[t] 
    \caption{\textbf{Greedy with Rounded Values}\\ (when we know that the instance is $\mu$-impartial)}
    \label{alg:greedy-reduction-mu}

\For {\text{\rm each item $1 \le t \le T$}}
{
    Let $\bar{v}_t = \max_{1 \le i \le N} v_{it}$
    
    \For{j = 1 to $\lceil \log \mu \rceil$}
    {
        Let there be a sub-item $(t, j)$ with supply $\frac{s_t}{\lceil \log \mu \rceil}$.

        Let each agent $i$'s value for the sub-item be:
        %
        \[
            v_{i(t,j)}=
            \begin{cases}
                \frac{\bar{v}_t}{2^j} & \mbox{if $v_{it}\geq \frac{\bar{v}_t}{2^j}$} \\[1ex]
                0 & \mbox{otherwise.}
            \end{cases}
        \]
    }
    
    Let Algorithm~\ref{alg:greedy-binary} allocate the sub-items and let the allocation be $(x_{i(t,j)})_{1 \le i \le N, 1 \le j \le \lceil \log \mu \rceil}$.
    
    Allocate $x_{it} = \sum_{j=1}^{\lceil \log \mu \rceil} x_{i(t,j)}$ amount of item $t$ to each agent $1 \le i \le N$.
}
\end{algorithm}

\begin{theorem}
    \label{thm:greedy-reduction-mu}
    Algorithm \ref{alg:greedy-reduction-mu} is $O(\log^2 \mu)$-competitive.
\end{theorem}

\begin{proof}
    Recall that $\vec{x^*} = (x^*_{it})_{1 \le i \le N, 1 \le t \le T}$ denote the Nash welfare maximizing allocation.
    We will consider a corresponding feasible allocation $(x'_{i(t,j)})$ of the sub-items as follows:
    %in the reduced binary-valuation instance: For any agent $i$ and item $t$,
    \[
        x'_{i(t,j)} =
        \begin{cases}
            \frac{x_{it}^*}{\lceil \log \mu \rceil} & \mbox{if $\frac{\bar{v}_t}{2^j}\leq v_{it}<\frac{\bar{v}_t}{2^{j-1}}$} \\[1ex]
            0 & \mbox{otherwise.}
        \end{cases}
    \]

    %In other words, $x'_{it_j}=\frac{x_{it}^*}{\lceil \log \mu \rceil}$ only for the minimum $j$ such that $v_{it}\geq \frac{\bar{v}_t}{2^j}$, otherwise $x'_{it_j} = 0$. This allocation is feasible since:
    %\begin{equation*}
    %    \sum_{i=1}^{N} x'_{it_j} \leq \sum_{i=1}^{N} \frac{x_{it}^*}{\lceil \log \mu \rceil} \leq \frac{s_t}{\lceil \log \mu \rceil} = s_{t_j}.
    %\end{equation*}

    Suppose that an agent $i$'s value for item $t$ satisfies $\frac{\bar{v}_t}{2^\ell} \le v_{it} < \frac{\bar{v}_t}{2^{\ell-1}}$ for integer $\ell \ge 1$.
    Then its utility for the sub-items $(t, j)$, $1 \le j \le \lceil \log \mu \rceil$, allocated to it would be:
    %
    \[
        \sum_{j=1}^{\lceil \log \mu \rceil} x'_{i(t,j)}v_{i(t,j)} = \sum_{j=\ell}^{\lceil \log \mu \rceil} x'_{i(t,j)}v_{i(t,j)} = \frac{x^*_{it}}{\lceil \log \mu \rceil} \sum_{j=\ell}^{\lceil \log \mu \rceil} \frac{\bar{v}_t}{2^j}
        ~.
    \]

    The summation on the right-hand-side is at least $\frac{\bar{v}_t}{2^j}$ and at most $\frac{\bar{v}_t}{2^{j-1}}$.
    Thus, we conclude that:
    %
    \begin{equation*}
        \frac{x_{it}^*v_{it}}{2\lceil \log \mu \rceil} \leq\sum_{j=1}^{\lceil \log \mu \rceil} x'_{i(t,j)}v_{i(t,j)} \leq \frac{x_{it}^*v_{it}}{\lceil \log \mu \rceil}.
    \end{equation*}

    The agents' utilities $\vec{u'}$ for the sub-items satisfy that for any agent $1 \le i \le N$:
    %
    \begin{equation*}
        \frac{u_i^*}{2\lceil \log \mu \rceil} \leq u'_i \leq \frac{u_i^*}{\lceil \log \mu \rceil}.
    \end{equation*}

    This implies two properties.
    First, the allocation of sub-items is $2\mu$-impartial since the original allocation $\vec{x^*}$ is $\mu$-impartial.
    Second, the Nash welfare of the allocation of sub-items is at least an $\Omega(\frac{1}{\log \mu})$ fraction of the optimal Nash welfare of the original instance.
    %Considering the impartial ratio in the allocation $(x'_{it_j})$, for any agents $i,j$,
    %\begin{equation*}
    %    \frac{u'_i}{u'_j} \leq \frac{2u_i^*}{u_j^*} \leq 2\mu.
    %\end{equation*}
    Therefore, by Lemma \ref{lem:binary-greedy-ratio}, we get an $O(\log \mu)$-competitive allocation comparing to the Nash welfare of sub-item allocation, which implies an $O(\log^2 \mu)$-competitive allocation w.r.t.\ the original instance.
\end{proof}


\subsection{Guessing the Impartiality Ratio}
\label{sec:greedy-reduction-general}

This is almost verbatim to the counterpart for balanced instances.
When we have no prior knowledge of the impartiality ratio, we can guess an upper bound by sampling from an appropriate distribution.
Since the final ratio depends logarithmically on the upper bound, it suffices to make a good enough guess that is at most a polynomial of the true impartiality ratio $\mu^*$.

We shall again consider a sequence of numbers starting from $2$, such that each sequel number is the square of the previous number.
We will sample each number $\mu$ with a probability that is inverse polynomial in $\log\log \mu$;
this ensures that the correct guess is made with a sufficiently large probability.
Finally, we apply the prior-dependent Greedy with Rounded Values algorithm (Algorithm~\ref{alg:greedy-reduction-mu}) with the guessed upper bound $\mu$.
See Algorithm~\ref{alg:greedy-reduction-general} for a formal definition.
%The algorithm needs to make an estimation $\lambda$ of the balance ratio $\lambda^*$, \textcolor{red}{and} then apply the previous algorithm with the estimated $\lambda$. We give a randomized algorithm for convenience of analysis.

\begin{algorithm}[t]
    \caption{\textbf{Greedy with Rounded Values}\\ (when we have no prior knowledge of the impartiality ratio)}
    \label{alg:greedy-reduction-general}
    
    Sample $\mu$ such that it equals $2^{2^k}$ with probability $\frac{6}{\pi^2} \cdot \frac{1}{(k+1)^2}$ for any non-negative integer $k$.
    
    Run Algorithm~\ref{alg:greedy-reduction-mu} with $\mu$ to allocate the items to the agents.
\end{algorithm}


\begin{theorem}
    \label{thm:greedy-reduction-general}
    Algorithm \ref{alg:greedy-reduction-general} is $O\big( \log^2\mu^* (\log \log \mu^*)^2 \big)$-competitive.
\end{theorem}

\begin{proof}
    Suppose that $k$ is the smallest positive integer such that the balance ratio $\mu^*$ is at most $2^{2^k}$.
    Then, we have $2^{2^{k-1}} < \mu^* \le 2^{2^k}$.
    This further implies that $\log \log \lambda^* > k - 1$.
    Hence, the algorithm correctly guesses $\mu = 2^{2^k}$ with probability at least $\Omega(\frac{1}{k^2}) = \Omega( \frac{1}{(\log\log \mu^*)^2})$.
    When that happens, the algorithm's Nash welfare is an $O(\log^2 \mu^* N)$ approximation to the optimal Nash welfare.
    Therefore, even if the algorithm got zero Nash welfare from the other guesses, we would still have the stated competitive ratio.
\end{proof}
