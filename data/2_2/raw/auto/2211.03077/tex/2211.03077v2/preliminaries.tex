\section{Preliminaries}
\label{sec:prelim}

\subsection{Nash Welfare Maximization}

Consider $N$ agents and $T$ divisible items.
Denote the supply of an item $t$ by $s_t$.
We represent an allocation of items to agents by a non-negative real vector $\vec{x} = \big(x_{it}\big)_{1 \le i \le N, 1 \le t \le T}$, where $x_{it}$ is the amount of item $t$ allocated to agent $i$.
A feasible allocation must comply with the supply constraints of items, that is, it must satisfy $\sum_{i = 1}^N x_{it} \le s_t$ for any item $t$.
For each agent $1 \le i \le N$ and each item $1 \le t \le T$, $v_{it} \ge 0$ denotes agent $i$'s value for receiving a unit of item $t$.
The agents' utilities are \textit{additive}:
If an agent $i$ receives $x_{it}$ amount of each item $t$, its utility equals $u_i = \sum_{t = 1}^{T} x_{it} v_{it}$.

\begin{definition}
    The \textit{Nash welfare} of an allocation $\vec{x} = (x_{it})_{1 \le i \le N, 1 \le t \le T}$ is the geometric mean of the agents' utilities:
    \begin{equation*}
        \left(\prod_{i = 1}^{N} u_i\right)^{1/N} ~ =  \quad \prod_{i = 1}^{N} \left( \sum_{t = 1}^{T} x_{it} v_{it} \right)^{1/N}.
    \end{equation*}    
\end{definition}

%A balance between fairness and efficiency is achieved by maximizing Nash welfare, or 
We also consider an equivalent objective, namely, maximizing the sum of logarithms of utilities:
%
\begin{equation*}
    \max ~ \sum_{i=1}^{N} \log u_{i}.
\end{equation*}

Let $\vec{x^*}=(x_{it}^*)_{1 \le i \le N, 1 \le t \le T}$ denote the allocation that maximizes the Nash welfare, breaking ties arbitrarily.
Let $\vec{u^*}=(u_{i}^*)_{1 \le i \le N}$ denote the corresponding utilities of the agents.

Maximizing the Nash welfare is a good proxy for balancing the efficiency and fairness of the allocation.
Concretely, when the items are divisible, it implies that any agent would get at least $\frac{1}{N}$ of its monopolist utility for receiving all items, a notion of fairness known as proportionality.

\begin{lemma}[c.f., \citet*{Vazirani:AGT:2007}]
    \label{lem:nsw-proportionality}
    The Nash welfare maximizing allocation $\vec{x^*}$ and the corresponding utilities $\vec{u^*}$ satisfy that for any agent $1 \le i \le N$:
    %
    \[
        u_i^* \ge \frac{1}{N} \sum_{t=1}^{T} s_t v_{it}
        ~.
    \]
    %
\end{lemma}

\begin{proof}
    Suppose for contrary that there is an agent $i$ such that $u_i^* < \frac{1}{N} \sum_{t=1}^{T} s_t v_{it}$.
We argue that it would be beneficial to allocate more to agent $i$.
Concretely, consider an alternative allocation $\vec{x'} = (x'_{it})_{1 \le i \le N, 1 \le t \le T}$ defined as:
%
\[
    x'_{jt} =
    \begin{cases}
        \displaystyle \frac{x_{jt}^*}{1 + \varepsilon} & \mbox{, if $j \ne i$;} \\[2.5ex]
        \displaystyle \frac{x_{it}^* + \varepsilon s_t}{1 + \varepsilon} & \mbox{, if $j = i$.}
    \end{cases}
\]

This is a feasible allocation because for any item $1 \le t \le T$:
%
\[
    \sum_{j=1}^N x'_{jt} = \frac{1}{1+\varepsilon} \left( \sum_{j \ne i}^N x_{jt} + \big( x_{it} + s_t \varepsilon \big) \right)
    \le \frac{1}{1+\varepsilon} \left( s_t + s_t \varepsilon \right) = s_t
    ~.
\]

Further comparing the agents' utilities to the counterparts in the assumed optimal allocation, we have:
%
\[
    u'_i = \sum_{t=1}^T x'_{it} v_{it} = \frac{1}{1+\varepsilon} \left( \sum_{t=1}^T x^*_{it} v_{it} + \varepsilon \sum_{t=1}^T s_t v_{it} \right) = \frac{1}{1+\varepsilon} \left( u^*_i + \varepsilon \sum_{t=1}^T s_t v_{it} \right)
    ~,
\]
%
and for any agent $j \ne i$ we have $u'_j = \frac{1}{1+\varepsilon} u^*_j$.
Hence, we get a contradiction that:
%
\[
    \frac{\left(\prod_{i = 1}^{N} u'_i\right)^{1/N}}{\left(\prod_{i = 1}^{N} u_i^*\right)^{1/N}} ~ = ~ \frac{\left( 1 + \varepsilon \frac{\sum_{t=1}^{T} s_t v_{it}}{u_i^*}\right)^{1/N}}{1 + \varepsilon} > 1
\]
%
for a sufficiently small $\varepsilon$ by the assumption of $u_i^* < \frac{1}{N} \sum_{t=1}^{T} s_t v_{it}$.
\end{proof}


\subsection{Online Algorithms}

This paper considers an online setting in which the items arrive one by one, while the agents are known from the beginning.
When each item arrives, the algorithm observes the item's supply and the agents' values for the item.
It must then decide how to allocate the item immediately and irrevocably.
We consider the ratio of the optimal Nash welfare to the expected Nash welfare of the algorithm's allocation.
The \emph{competitive ratio} of an algorithm is the maximum of this ratio over all possible instances.
%The performance of an algorithm is evaluated by the \emph{competitive ratio}, defined as the maximum ratio between NSW of offline optimal solution and that obtained by the algorithm over all instances.

\paragraph{Greedy Algorithms with Anticipated Utilities.}

A natural strategy to allocate an item $t$ is to first estimate how much utility each agent $i$ could get from the other items, denoted as $u'_{it}$ and referred to as agent $i$'s anticipated utility.
We may then allocate item $t$ greedily to maximize the Nash welfare based on the anticipated utilities.
For example, a natural yet conservative form of anticipated utilities in our model would be the agents' utilities from the previous items.
In other models, the anticipated utilities may depend on some prior knowledge of the agents' values; for instance, the algorithm of \citet{BanerjeeGGJ:SODA:2022} may be viewed as a greedy algorithm with anticipated utilities that depend on the agents' monopolist utilities.

It is therefore instructive to first examine some basic properties of this family of algorithms.
We may formulate the allocation problem conditioned on anticipated utilities $u'_{it}$ as a convex program:
\begin{align}
    \label{eqn:greedy-predicted-utility}
    \text{maximize} & \quad \sum_{i=1}^N \log(u'_{it} + v_{it} x_{it})
    \\
    \notag
    \text{subject to} & \quad \sum_{i=1}^N x_{it} \le s_t \quad \mbox{and} \quad x_{it} \ge 0 \mbox{ for any agent $i$.}
\end{align}

Since the objective is monotone in $x_{it}$'s, the optimal solution to the above program, denoted as $\vec{z}_t = (z_{it})_{1 \le i \le N}$, must satisfy the first constraint with equality, i.e.:
%
\begin{equation}
    \label{eqn:greedy-predicted-utility-allocate-all}
    \sum_{i=1}^N z_{it} = s_t
    ~.
\end{equation}

Further, for the optimal multiplier $\nu^* \ge 0$ of the first constraint and for any agent $1 \le i \le N$, the optimality conditions imply that:
%
%Let $\nu^*$ be the solution to:
%\begin{equation*}
%    \sum_{i=1}^N \max\{1/\nu^*-u'_{it}/v_{it},0\} = s,
%\end{equation*}
%then the optimal solution $\mathbf{z_t}=(z^*_{it})_{i\in[N]}$ to Equation \eqref{eqn:greedy-predicted-utility} is:
%
\begin{equation}
    \label{eqn:greedy-predicted-utility-optimal}
    z_{it} = \max \left\{ \frac{1}{\nu^*}-\frac{u'_{it}}{v_{it}} ~, ~ 0 \right\}
    ~.
\end{equation}
We give the following lemma to bound the gain of the logarithm of Nash welfare when we follow the optimal solution from Eqn.~\eqref{eqn:greedy-predicted-utility-optimal} to allocate an item $t$.

\begin{lemma}
    \label{lem:greedy-predicted-utility-increase}
    The optimal solution $\vec{z}$ to convex program \eqref{eqn:greedy-predicted-utility} satisfies that:
    %
    \[
        \sum_{i=1}^{N} \log(u'_{it} +v_{it} z_{it}) - \sum_{i=1}^{N} \log u'_{it} \geq s_t \cdot \max_{1 \le i \le N} \frac{v_{it}}{u'_{it} + v_{it} z_{it}}
        ~.
    \]
    %
\end{lemma}

\begin{proof}
    By the concavity of logarithm, the left-hand side is at least:
    %
    \[
        \sum_{i=1}^N \frac{v_{it} z_{it}}{u'_{it} + v_{it} z_{it}}
    \]

    Further by Eqn.~\eqref{eqn:greedy-predicted-utility-optimal}, if $z_{it} > 0$ then $i$ maximizes $\frac{v_{it}}{u'_{it} + v_{it} z_{it}}$ (with maximum value $\nu^*$).
    Hence, the above equals:
    %
    \[
        \max_{1 \le i \le N} \frac{v_{it}}{u'_{it} + v_{it} z_{it}} ~ \sum_{i=1}^N z_{it}
        ~.
    \]

    The lemma now follows by Eqn.~\eqref{eqn:greedy-predicted-utility-allocate-all}.
\end{proof}


\paragraph{Randomized versus Deterministic Algorithms.}
%
For divisible items, the best competitive ratios achievable by randomized and deterministic online algorithms are the same.
Given any randomized algorithm, we may convert it into a deterministic one such that for each item $t$, the amount of item $t$ that the deterministic algorithm allocates to any agent $i$ equals the expected amount that the randomized algorithm would allocate.
Since the Nash welfare is a concave function of the allocation, the deterministic algorithm yields a weakly larger Nash welfare.
Therefore, our positive results will describe online algorithms in their randomized form if that simplifies the presentation.
In our negative results, on the other hand, it suffices to consider deterministic algorithms.

\subsection{Balanced and Impartial Instances}


\citet{BanerjeeGGJ:SODA:2022} showed that for arbitrary instances, no online algorithm can have a competitive ratio better than the trivial $O(N)$.
They then explored the model of online algorithms with predictions, where the algorithms know the agents' monopolist utilities for receiving all items.

We observe that the agents' values in the hard instances of \citet{BanerjeeGGJ:SODA:2022} are lopsided:
the largest value is exponentially larger than the smallest.
This is rarely the case in real resource allocation problems.
Recall the example of allocating food and computational resources. It is almost impossible to see agents' values towards the same item differ substantially.
Hence this paper aims to design algorithms with good performance on ``natural instances'' in which different agents are of ``similar importance''.
We define two notions of ``natural instances''.
Motivated by \citet{BanerjeeGGJ:SODA:2022}, our first notion compares the agents' monopolist utilities for receiving all items.

\begin{definition}
    \label{def:balanced-instance}
    An instance is $\lambda$-\emph{balanced} if for any agents $1 \le i, j \le N$:
    %
    \[
    \sum_{t = 1}^{T} s_t v_{it} \le \lambda \sum_{t = 1}^{T} s_t v_{jt}
    ~.
    \]
    %
    We shall refer to $\lambda^* = \frac{\max_{1 \le i \le N} \sum_{t = 1}^{T} s_t v_{it}}{\min_{1 \le i \le N} \sum_{t = 1}^{T} s_t v_{it}}$ as the \emph{balance ratio} of the instance.
\end{definition}

We remark again that competitive online algorithms for $\lambda$-balanced instances can be transformed into online algorithms with predictions in the model of \citet{BanerjeeGGJ:SODA:2022}.
Given prediction $\tilde{V}_i$ of each agent $i$'s monopolist utility $V_i = \sum_{t=1}^{T} s_t v_{it}$ that is $(\alpha, \beta)$-approximate, i.e., $\alpha V_i \ge \tilde{V}_i \ge \frac{1}{\beta} V_i$, we can normalize agent $i$'s values to be $v_{it}' = \frac{v_{it}}{\tilde{V}_i}$ for all items $t$ to get an $\alpha \beta$-balanced instance.
%By this reduction, our results in Section~\ref{sec:???} imply an $O(\log \alpha \beta N)$ competitive algorithm in the model with predictions, a slight improvement over the $O(\alpha \log \beta N)$ competitive ratio of \citet{BanerjeeGGJ:SODA:2022}.
%They give an $O(\alpha \log\beta N)$-competitive algorithm if every prediction $\tilde{V}_i\in \left[\frac{1}{\beta}V_i, \alpha V_i\right]$. From the perspective of \emph{balance ratio}, the instance is $\alpha \beta$-balanced after normalizing the value by $v_{it}' = \frac{v_{it}}{\tilde{V}_i}$.

Our second notion examines whether different agents get similar utilities in the Nash welfare maximizing allocation.

\begin{definition}%[Impartial Instance]
    \label{def:impartial-instance}
    
    Given any instance, an allocation $\vec{x}$ is $\mu$-\emph{impartial} if the corresponding utilities $\vec{u}$ satisfy that for any agents $1 \le i, j \le N$:
    %
    \[
    u_i \le \mu \cdot u_j
    ~.
    \]
    %
    An instance is $\mu$-impartial if every Nash welfare maximizing allocation $\vec{x}^{*}$ is $\mu$-impartial.
    Let $\mu^*$ be the smallest value of $\mu$ such that the instance is $\mu$-impartial;
    we shall refer to $\mu^*$ as the \emph{impartiality ratio} of the instance.
    
\end{definition}

%The main implication of impartiality is that 
Impartiality has a simple yet important implication:
For each item, we may ignore the agents whose values for the item are much smaller than the highest value.
We make this precise with the next lemma.

\begin{lemma}
    \label{lem:maximum-mu-value}
    For any agent $i$ and any item $t$, if $x_{it}^*>0$ then $v_{it}\geq \frac{1}{\mu^{*}} \max_{1 \le j \le N}v_{jt}$.
\end{lemma}
\begin{proof}
    Suppose for contradiction that there are agent $i$ and item $t$ for which we have $x_{it}^*>0$ but $v_{it}<\frac{1}{\mu^{*}} \max_{1 \le j \le N}v_{jt}$.
We argue that we should have allocated less item $t$ to agent $i$.
Let $j$ be an agent with highest value $v_{jt}$ for item $t$.
Consider reallocating an $\varepsilon$ amount of item $t$ from agent $i$ to agent $j$.
We claim that the Nash welfare increases for a sufficiently small $\varepsilon$.
Since the other agents' utilities stay the same, it suffices to prove that:
\begin{equation*}
    (u_i^* - \varepsilon v_{it}) (u_j^* + \varepsilon v_{jt}) - u_i^* u_j^* = \varepsilon (u_i^* v_{jt} - u_j^* v_{it}) - \varepsilon ^2 v_{it} v_{jt}
\end{equation*}
%
is positive.
Since $v_{it} < \frac{1}{\mu^*} v_{jt}$ by our assumption for contradiction and $u_j^* \le \mu^* u_i^*$ by the definition of $\mu^*$, we get that $u_i^* v_{jt} - u_j^* v_{it} > 0$.
Hence, the above is positive for a sufficiently small $\varepsilon$.
\end{proof}

Finally, the balance ratio and impartiality ratio are within a factor $N$ from each other.

\begin{lemma}
    \label{lem:balance-impartial}
    For any instance, we have $\lambda^* \leq \mu^* N$ and $\mu^* \leq \lambda^* N$.
\end{lemma}

\begin{proof}
    We first prove that $\lambda^* \le \mu^* N$.
    Let $i$ and $j$ be the agents with the maximum and minimum values for receiving all items respectively.
    We have:
    %
    \begin{align*}
        \sum_{t=1}^{T} s_t v_{it}
        &
        = \lambda^* \sum_{t=1}^{T} s_t v_{jt} \geq \lambda^* u_j^* \\
        &
        \ge \frac{\lambda^*}{\mu^*} u_i^*
        && \mbox{(definition of $\mu^*$)} \\
        &
        \ge \frac{\lambda^*}{\mu^* N} \sum_{t=1}^{T} s_t v_{it}
        ~.
        && \mbox{(Lemma~\ref{lem:nsw-proportionality})}
    \end{align*}
    
    Cancelling $\sum_{t=1}^{T} s_t v_{it}$ on both sides proves the inequality.

    Next, we show that $\mu^* \le \lambda^* N$ using a similar argument.
    Let $i$ and $j$ be the agents with the minimum and maximum utilities in the Nash welfare maximizing allocation respectively.
    We have:
    \begin{align*}
        \sum_{t=1}^{T} s_t v_{it}
        &
        \geq \frac{1}{\lambda^*} \sum_{t=1}^{T} s_t v_{jt}
        && \mbox{(definition of $\lambda^*$)} \\
        &
        \geq \frac{1}{\lambda^*} u_j^* = \frac{\mu^*}{\lambda^*} u_i^* \\
        &
        \ge \frac{\mu^*}{\lambda^* N} \sum_{t=1}^{T} s_t v_{it}
        ~.
        && \mbox{(Lemma~\ref{lem:nsw-proportionality})}
    \end{align*}
    
    Cancelling $\sum_{t=1}^{T} s_t v_{it}$ on both sides proves the inequality.
\end{proof}

In conclusion, these two notions reflect the ``naturality'' of an instance, as a replacement of prediction in previous works.
In Section \ref{sec:balance}, we study balanced instances and achieve $O(\log \lambda^* N)$-competitive ratio.
For impartial instances, besides the $O(\log \mu^* N)$ result as a corollary of Lemma \ref{lem:balance-impartial}, in Section \ref{sec:impartial} we give an online algorithm whose competitive ratio is $O(\log^2 \mu^*)$, only depending on the impartiality ratio. (All $\log\log$ factors are omitted here.)
Therefore, hopefully the impartiality ratio is the better one to use.