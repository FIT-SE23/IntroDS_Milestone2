% !TeX spellcheck = en_GB
%!TEX root = ../side-constrained.tex

\ifarxiv
	\section{Existence of Unconstrained Dynamic Equilibria}\label{app:VI-Existence}
\else
	\subsection{Existence of Unconstrained Dynamic Equilibria}
\fi

In \Cref{sec:dynamic} we restated\ifarxiv{} in \Cref{thm:VICharOfDE,thm:ExistenceUnconstrained}\fi{} a well known characterization and existence result for unconstrained dynamic equilibria in the notation and under the assumptions used throughout this paper. While none of the analogous results from literature known to us (\eg \ifarxiv\cite{CominettiCL15,Friesz93,Han2013,ZhuM00}\else\citealt{CominettiCL15,Friesz93,Han2013,ZhuM00}\fi) exactly match the model used in this paper, the respective theorems can still be proven in essentially the same way. For completeness we provide the adjusted proofs here:

\ifarxiv\else
\begin{repeattheorem}[\Cref{thm:VICharOfDE}]
	Assume that \ref{ass:PsiBounded} holds. Then, a walk inflow $h^* \in \Lambda(r)$ ($h^* \in \Lambda(Q)$) is a dynamic equilibrium with fixed inflow rates (with fixed flow volume) if and only if $h^*$ is a solution to \eqref{eqn:vi-fixed-inflow-uc} (to \eqref{eqn:vi-fixed-volume-uc}).
\end{repeattheorem}
\fi

\begin{proofNormal}[Proof of \Cref{thm:VICharOfDE}]
	First, consider the case of fixed inflow rates and let $h^*$ be a solution to the variational inequality \eqref{eqn:vi-fixed-inflow-uc}. Let $p,q \in \Pc_i$ be any two walks of some commodity $i \in I$ and $J \coloneqq \Set{t \in \planningInterval | h^*_p(t) > 0, \Psi_p(t) > \Psi_q(t)}$ the set of all times with strictly positive inflow of commodity $i$ into walk $p$ where $q$ would be a better alternative. We then define $h$ as the flow obtained by shifting all inflow of commodity~$i$ during $J$ from $p$ to $q$, i.e.
	\begin{align*}
		h_p(t) &= 0 &\text{ for all } t \in J \\
		h_q(t) &= h^*_q(t) + h^*_p(t) &\text{ for all } t \in J \\
		h_{p'}(t) &=h^*_{p'}(t) &\text{ in all other cases.}
	\end{align*}
	We then clearly have $h \in \Lambda(r)$ and, as $h^*$ is a solution to \eqref{eqn:vi-fixed-inflow-uc}, we get
	\begin{align*}
		0 	&\leq \scalar{\Psi(h^*)}{h-h^*} = \int_J \Psi_p(t)\left(0-h^*_p(t)\right)\diff t + \int_J \Psi_q(t)\left(h^*_q(t) + h^*_p(t)-h^*_q(t)\right)\diff t \\
		&=\int_J \left(\Psi_q(t)-\Psi_p(t)\right)h^*_p(t)\diff t.
	\end{align*}
	As $h^*_p$ is strictly positive and $\Psi_q(h,\emptyarg)-\Psi_p(h,\emptyarg)$ strictly negative on all of $J$, this implies that $J$ has measure zero. In other words, we have $\Psi_p(h,t) \leq \Psi_q(h,t)$ for almost all $t$ with $h^*_p(t)>0$. Thus, $h^*$ is indeed a dynamic equilibrium. 
	
	For the other direction, let $h^* \in \Lambda(r)$ be a dynamic equilibrium and $h \in \Lambda(r)$ any feasible flow. Defining
	\[\psi_i: \planningInterval \to \IR_{\geq 0}, t \mapsto \inf\Set{\Psi_p(h^*,t) | p \in \Pc_i}\]
	for every commodity $i \in I$ we get
	\[\Psi_p(h^*,t)\left(h_p(t) - h^*_p(t)\right) \geq \psi_i(t)\left(h_p(t) - h^*_p(t)\right)\]
	for almost all $t \in \planningInterval$ and every walk $p \in \Pc_i$ (by case-distinction on the second factor being negative or non-negative and using the fact that $h^*$ satisfies \eqref{eq:de-rate}). From this we directly get
	\begin{align*}
		&\scalar{\Psi(h^*)}{h-h^*} = \\
		&\quad=\sum_{i \in I}\sum_{p \in \Pc_i}\int_{t_0}^{t_f} \Psi_p(h^*,t)\left(h_p(t) - h^*_p(t)\right)\diff t \\
		&\quad\geq \sum_{i \in I}\sum_{p \in \Pc_i}\int_{t_0}^{t_f}\psi_i(t)\left(h_p(t) - h^*_p(t)\right)\diff t \\
		&\quad= \sum_{i \in I}\int_{t_0}^{t_f}\psi_i(t)\left(\sum_{p \in \Pc_i}h_p(t) - \sum_{p \in \Pc_i}h^*_p(t)\right)\diff t \\
		&\quad= \sum_{i \in I}\int_{t_0}^{t_f}\psi_i(t)\left(r_i(t) - r_i(t)\right)\diff t = 0.
	\end{align*}
	Therefore, $h^*$ is indeed a solution to the variational inequality \eqref{eqn:vi-fixed-inflow-uc}. 
	
	Now, consider the case of fixed flow volumes, let $h^*$ be a solution to the variational inequality \eqref{eqn:vi-fixed-volume-uc} and assume that $h^*$ is not a dynamic equilibrium. Then there must be a commodity $i \in I$, walks $p,q \in \Pc_i$, sets of positive measure $J_p, J_q \subseteq \planningInterval$ and constants $\varepsilon, \nu > 0$ such that
	\begin{align*}
		\forall t \in J_p: h^*_p(t) \geq \varepsilon \text{ and } \Psi_p(h^*,t) > \nu \\
		\forall t \in J_q: h^*_q(t) \leq B_p - \varepsilon \text{ and } \Psi_q(h^*,t) < \nu.
	\end{align*}
	We can also assume \wlofg that $J_p$ and $J_q$ have the same size (\wrt the Lebesgue measure on $\IR$). We now define $h$ as the flow obtained from $h^*$ by shifting flow at a rate of $\varepsilon$ in space from $p$ to $q$ and in time from $J_p$ to $J_q$, i.e.
	\begin{align*}
		h_{p}(t) &\coloneqq h^*_p(t) - \varepsilon &\text{ for all } t \in J_p \\
		h_{q}(t) &\coloneqq h^*_q(t) + \varepsilon &\text{ for all } t \in J_q \\
		h_{p'}(t) &=h^*_{p'}(t) &\text{ in all other cases.}
	\end{align*}
	Clearly, we have $h \in \Lambda(Q)$ and additionally we get
	\begin{align*}
		&\scalar{\Psi(h^*)}{h-h^*} \\
		&\quad= \int_{J_p} \Psi_{p}(h^*,t)\left(h^*_p(t)-\varepsilon-h^*_p(t)\right)\diff t + \int_{J_q} \Psi_{q}(h^*,t)\left(h^*_q(t) + \varepsilon - h^*_q(t)\right)\diff t \\
		&\quad= -\int_{J_p} \Psi_{p}(h^*,t)\varepsilon\diff t + \int_{J_q} \Psi_{q}(h^*,t) \varepsilon\diff t \\
		&\quad< - \int_{J_p} \nu\varepsilon \diff t + \int_{J_q} \nu\varepsilon \diff t = 0.
	\end{align*}
	But this is now a contradiction to $h^*$ being a solution to the variational inequality \eqref{eqn:vi-fixed-volume-uc}. Thus, $h^*$ must have been a dynamic equilibrium. 
	
	For the other direction, let $h^* \in \Lambda(Q)$ be a dynamic equilibrium with corresponding values $\nu_i \geq 0$ and $h \in \Lambda(Q)$ any feasible flow. Then we have 
	\[\Psi_p(h^*,t)\left(h_p(t) - h^*_p(t)\right) \geq \nu_i\left(h_p(t) - h^*_p(t)\right)\]
	for every time $t \in \planningInterval$ and walk $p \in \Pc_i$ (by case-distinction on the second factor being negative, positive or zero and the fact that $h^*$ satisfies \eqref{eq:de-volume}). From this we directly get
	\begin{align*}
		&\scalar{\Psi(h^*)}{h-h^*} = \\
		&\quad=\sum_{i \in I}\sum_{p \in \Pc_i}\int_{t_0}^{t_f} \Psi_p(h^*,t)\left(h_p(t) - h^*_p(t)\right)\diff t \\
		&\quad\geq \sum_{i \in I}\sum_{p \in \Pc_i}\int_{t_0}^{t_f}\nu_i\left(h_p(t) - h^*_p(t)\right)\diff t \\
		&\quad= \sum_{i \in I}\nu_i \left(\sum_{p \in \Pc_i}\int_{t_0}^{t_f}h_p(t)\diff t - \sum_{p \in \Pc_i}\int_{t_0}^{t_f}h^*_p(t)\diff t\right) \\
		&\quad= \sum_{i \in I}\nu_i\left(Q-Q\right) = 0.
	\end{align*}
	Therefore, $h^*$ is indeed a solution to the variational inequality \eqref{eqn:vi-fixed-volume-uc}. 
\end{proofNormal}

\ifarxiv\else
\begin{repeattheorem}[\Cref{thm:ExistenceUnconstrained}]
	For any network and \effWalkDelay s satisfying \labelcref{ass:FinitelyManyWalks,ass:nonEmptyPathset,ass:PsiWScont,ass:PsiBounded} there exists a dynamic equilibrium (both with and without departure time choice).
\end{repeattheorem}
\fi

\begin{proofNormal}[Proof of \Cref{thm:ExistenceUnconstrained}]
	It is easy to see that both $\Lambda(r)$ and $\Lambda(Q)$ are non-empty, convex, closed and bounded (with respect to the $L^2$-norm): 
	\begin{itemize}
		\item Non-emptyness follows from \labelcref{ass:nonEmptyPathset} and our general assumption on the choice of the walk-inflow bounds~$B_p$.
		\item Convexity follows from the fact that the constraints defining $\Lambda(r)$ and $\Lambda(Q)$ are all linear.
		\item For closedness let $h^n \in L^2_+(\planningInterval)^\Pc$ be a sequence of functions converging to some $h \in L^2_+(\planningInterval)^\Pc$ (with respect to the $L^2$-norm). If all $h^n$ are from $\Lambda(r)$ then so is $h$ as we have
		\begin{align*}
			&\int_{t_0}^{t_f}\abs{r_i(t) - \sum_{p \in \Pc_i}h_p(t)}\diff t 
			= \int_{t_0}^{t_f}\abs{\sum_{p \in \Pc_i}h^n_p(t) - \sum_{p \in \Pc_i}h_p(t)}\diff t \\
			&\quad\quad\leq \sum_{p \in \Pc_i}\int_{t_0}^{t_f}\abs{h^n_p(t) - h_p(t)}\diff t \\
			&\quad\quad\leq \sum_{p \in \Pc_i}\left(\int_{t_0}^{t_f}\left(h_p^n(t) - h_p(t)\right)^2\diff t\right)^{1/2}\cdot\left(\int_{t_0}^{t_f}1^2\diff t\right)^{1/2} \overset{n \to \infty}{\longrightarrow} 0
		\end{align*}
		and, therefore, $\sum_{p \in \Pc_i}h_p(t) = r_i(t)$ for all $i \in I$ and almost all $t \in \planningInterval$. 
		If all $h^n$ are from $\Lambda(Q)$ then so is $h$ as we have
		\begin{align*}
			&\abs{Q_i - \sum_{p \in \Pc_i}\int_{t_0}^{t_f}h_p(t)\diff t} 
				= \abs{\sum_{p \in \Pc_i}\int_{t_0}^{t_f}h^n_p(t)\diff t - \sum_{p \in \Pc_i}\int_{t_0}^{t_f}h_p(t)\diff t}\\
			&\quad\quad=\abs{\sum_{p \in \Pc_i}\int_{t_0}^{t_f} h^n_p(t) - h_p(t)\diff t} 
				\leq \sum_{p \in \Pc_i}\int_{t_0}^{t_f}\abs{h^n_p(t) - h_p(t)}\diff t \\
			&\quad\quad\leq \sum_{p \in \Pc_i}\left(\int_{t_0}^{t_f}\left(h^n_p(t) - h_p(t)\right)^2\diff t\right)^{1/2}\cdot\left(\int_{t_0}^{t_f}1^2\diff t\right)^{1/2} \overset{n \to \infty}{\longrightarrow} 0.
		\end{align*}
		Furthermore, $h$ is also bounded by $B_p$ almost everywhere as otherwise we would have some $p \in \Pc$, $\varepsilon > 0$ and some set $J \subseteq \planningInterval$ of positive measure with $h_p(t) \geq B_p + \varepsilon$ for all $t \in J$. But this would imply the following contradiction:
		\begin{align*}
			0 = \lim_n \int_{t_0}^{t_f}\left(h_p(t) - h^n_p(t)\right)^2\diff t \geq \int_J\varepsilon^2\diff t = \varepsilon^2\abs{J}.
		\end{align*}
		\item For boundedness observe that both for $\Lambda(r)$ and $\Lambda(Q)$ there exist fixed bounded $L^2$-functions bounding every walk inflow function $h_p$ of any feasible $h$ ($r_i$ and $B_p$, respectively).
	\end{itemize}
	Thus, we can choose $C = \Lambda(r) \subseteq L^2_+(\planningInterval)^\Pc$ or $C = \Lambda(Q) \subseteq L^2_+(\planningInterval)^\Pc$ and $\A = \Psi$ in \Cref{thm:Lions} to obtain a solution to \eqref{eqn:vi-fixed-inflow-uc} or \eqref{eqn:vi-fixed-volume-uc}, respectively. By \Cref{thm:VICharOfDE} those solution are then also dynamic equilibria.
\end{proofNormal}

\ifarxiv
\begin{remark}\label{rem:JustificationPathInflowBounds}
	Here we see why the walk inflow bounds $B_p$ are needed for the case with departure time choice as these ensure that $\Lambda(Q)$ is bounded. Without those bounds it is easy to construct instances without an equilibrium: Consider for example a network consisting of just a single edge $e$ and a flow independent cost function $\Psi_{1,\set{e}}(h,t) \coloneqq t$. Then for every possible flow all particles entering the network at a time different to $t=0$ can improve by shifting to a time closer to $0$. Thus, there is no equilibrium flow in this instance (and also no solution to the corresponding variational inequality).
\end{remark}
\fi