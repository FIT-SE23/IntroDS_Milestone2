% !TeX spellcheck = en_GB
%!TEX root = ../side-constrained.tex

\section{Characterization of \SCDE{} via (Quasi-)Variational Inequalities}\label{sec:characterization}

Similar to the characterizations of unconstrained dynamic equilibria with variational inequalities (\cf \Cref{thm:VICharOfDE}) we now want to characterize side-constrained dynamic equilibria using \emph{quasi}-variational inequalities (QVIs). This is not only of theoretical interest but there are also algorithms solving  them, see \eg \citefull{KanzowSteckQVI}, \citefulls{Shehu20} and references therein. Note, however, that the convergence guarantees given by \citeauthor*{Shehu20} require a certain strong monotonicity property for the mapping $h \mapsto \Psi(h,.)$ which, in general, is not satisfied for dynamic flows whereas \citeauthor{KanzowSteckQVI} only need weak-strong continuity but instead require some convexity assumptions on the sets $S$ and $M(h)$.


\subsection{Quasi-Variational-Inequality}

Let us define the following nonnegative tangent cone with respect to $S$, $A_p$ and $h$.
\begin{equation}
	T(S,A_p,h):=\Set{v\in L^2(\planningInterval)^{\Pc} | \begin{array}{l}
			\exists (h^n)_{n \in \IN} \subset M(h), (t_n)_{n \in \IN} \subset \IR_{>0}: \\ 
			\lim_{n\rightarrow\infty} t_n=0,  \lim_{n\rightarrow\infty} \frac{h^n-h}{t_n}=v
		\end{array}}.
\end{equation}
where $M(h) \coloneqq \bigcup_{i \in I}M_i(h)$ is the set of all walk inflows reachable by a single \addmEpsDev{} from $h$.

We introduce the following assumptions on the correspondences $A_p$:
\begin{definition}
	The correspondence $(A_p)_{p \in \Pc}$ are \emph{closed under rate-reduction} at $h \in S$, if for all $i \in I$, $q,p \in \Pc_i$, $\varepsilon, \varepsilon', \Delta$ and $J$, we have:
	\[(q,J,\varepsilon,\Delta) \in A_{p}(h), \varepsilon' \leq \varepsilon \implies (q,J,\varepsilon',\Delta) \in A_{p}(h).\]
\end{definition}

\begin{definition}
	The correspondences $(A_p)_{p \in \Pc}$ are \emph{closed under time-restriction} at $h \in S$, if for all $i \in I$, $q,p \in \Pc_i$, $\varepsilon, \Delta, J'$ and $J$, we have:
	\[(q,J,\varepsilon,\Delta) \in A_{p}(h), J' \subseteq J \implies (q,J',\varepsilon,\Delta) \in A_{p}(h).\]
\end{definition}

\begin{enumerate}[label=(A\arabic*),resume=Assumptions]
	\item The \addmEpsDev s are closed under rate-reduction at all $h \in S$.\label[asmpt]{ass:closedSpace}
	\item The \addmEpsDev s are closed under time-restriction at all $h \in S$.\label[asmpt]{ass:closedTime}
\end{enumerate}

The first assumption states that whenever flow is allowed to deviate at a certain rate, it is also allowed to deviate at any lower rate. The second assumption states that whenever flow is allowed to deviate during a certain neighbourhood, the same deviation is also allowed during any subset of that neighbourhood.
It will turn out that several well-motivated equilibrium concepts fulfil both
assumptions (see \Cref{obs:CDEcharbyQVI} for details).

\begin{obs}\label{obs:ClosedSpaceTimeConvex}
	Under \ref{ass:TrivialDeviation}, assumption~\ref{ass:closedSpace} is a weaker assumption than convexity, \ie if $M_i(h)$ is convex (at $h$), then \ref{ass:closedSpace} holds. This is true because for $\varepsilon' \leq \varepsilon$, the walk inflow $H_{p\to q}^r(h,J,\varepsilon',\Delta)$ is a convex combination of $h=H_{p\to p}^r(h,J,\varepsilon,0)$ and $H_{p\to q}^r(h,J,\varepsilon,\Delta)$:
	\[H_{p\to q}^r(h,J,\varepsilon',\Delta) = (1-\tfrac{\varepsilon'}{\varepsilon})\cdot H_{p\to p}^r(h,J,\varepsilon,0) + \tfrac{\varepsilon'}{\varepsilon}\cdot H_{p\to q}^r(h,J,\varepsilon,\Delta).\]
	
	Assumption~\ref{ass:closedTime} is independent of convexity, \ie there exists a set $M_i(h)$ which is convex but does not satisfy \ref{ass:closedTime} and there exists a set $M_i(h)$ which satisfies \ref{ass:closedTime} but is not convex. E.g., consider a network with a single commodity with a fixed inflow rate $r = \CharF[{[0,2]}]$, two nodes $s$ and $t$ and two parallel edges $e_1$ and $e_2$ connecting $s$ and $t$ (these are then also the only $s$,$t$-paths $p$ and $q$). We define the following sets $S \subseteq \Lambda(r)$ with corresponding sets $A_{p}(h) \coloneqq \set{(q,J,\varepsilon,0) | H_{p \to q}(h,J,\varepsilon,0) \in S}$:
	\begin{itemize}
		\item $S_1$ contains all walk inflows $h \in \Lambda(r)$ which at any point in $[0,2]$ sent all flow in exactly one of the two paths. Clearly, the resulting \addmEpsDev s satisfy \ref{ass:closedTime}. The set $S$ is, however, not convex as it contains the walk inflow $h^1$ which sends all flow into $p$ as well as the walk inflow $h^2$ which sends all flow into $q$ but not any of their non-trivial convex combinations.
		\item $S_2 \coloneqq \mathrm{conv}(h^1,h^2)$ is a convex set, but the corresponding sets $A_p(h)$ do not satisfy \ref{ass:closedTime} since we have $H^r_{p\to q}(h^1,[0,2],1,0) = h^2 \in S_2$ but $H^r_{p\to q}(h^1,[0,1],1,0) \notin S_2$.
	\end{itemize}
\end{obs}

We now consider the following quasi-variational inequality:

\begin{equation}\label{eq:QVI-SCDE}\tag{\ensuremath{\QVI(\Psi,S,A_p)}}
	\begin{aligned}
		\text{Find }h^* \in  S  \text{ such that}:&\\
		\scalar{\Psi(h^*)}{v} &\geq 0 \text{ for all } v \in T(S,A_p,h^*).\end{aligned}
\end{equation}

\begin{theorem}\label{thm:VI-fixed-inflow:sufficient}
	Let $h^* \in S$ be given such that $S$ and $(A_p)_{p \in \Pc}$ satisfy \ref{ass:closedSpace} at $h^*$ and $\Psi$ such that \ref{ass:EffectivePathDelayContinuous} holds. If $h^*$ is a solution to the quasi-variational inequality \eqref{eq:QVI-SCDE} then it is a \SCDE{} \wrt $S$ and $(A_p)_{p \in \Pc}$.
\end{theorem}

\begin{proof}
	Let $h^* \in  S$ be a solution to \eqref{eq:QVI-SCDE} and assume that  $h^*$ is not a \SCDE. Then there exists a commodity $i$, walks $p,q \in \Pc_i$, a shift $\Delta$ and some time $t \in \planningInterval$ such that $\Psi_p(h^*,t) > \Psi_q(h^*,t+\Delta)$ and $(q,\Delta) \in U_{p}(h^*,t)$. Since $\Psi_q(h^*,.)$ and $\Psi_p(h^*,.)$ are continuous (by \ref{ass:EffectivePathDelayContinuous}) there must be some  constants $\delta, \gamma > 0$ such that $\Psi_p(h^*,t') - \Psi_q(h^*,t'+\Delta) \geq \gamma$ holds for all $t' \in [t-\delta,t+\delta]$. From $(q,\Delta) \in U_{p}(h^*,t)$ we then get some constant $\varepsilon > 0$ and a measurable set $J \subseteq [t-\delta,t+\delta]$ with $\int_J\min\set{h^*_p(t'),\varepsilon}\diff t' > 0$ and $\bar h \coloneqq H^r_{p\to q}(h^*,J,\varepsilon,\Delta) \in M_i(h^*)$. Because of \ref{ass:closedSpace}, we now have $\bar h- h^* \in T(S,A_p,h^*)$.	But at the same time we have
	\begin{align*}
		&\scalar{\Psi(h^*)}{\bar h-h^*} 
		= \sum_{w \in \Pc}\int_{\tStart}^{\tEnd} \Psi_w(h^*(t'))\cdot\left(\bar h_w(t')-h^*_w(t')\right)\diff t'\\
		&\quad\quad=\int_J\Psi_p(h^*,t')\cdot\left(\bar h_p(t')-h_p^*(t')\right)\diff t' + \int_{J+\Delta}\Psi_q(h^*,t')\cdot\left(\bar h_q(t')-h_q^*(t')\right)\diff t' \\
		&\quad\quad=\int_J\Psi_p(h^*,t')\cdot\left(\bar h_p(t')-h_p^*(t')\right) + \Psi_q(h^*,t'+\Delta)\cdot\left(\bar h_q(t'+\Delta)-h_q^*(t'+\Delta)\right)\diff t' \\
		&\quad\quad=\int_J\left(\Psi_q(h^*,t'+\Delta)-\Psi_p(h^*,t')\right)\cdot\min\set{h^*_p(t'),\varepsilon}\diff t' \\
		&\quad\quad\leq -\gamma \cdot \int_J\min\set{h^*_p(t'),\varepsilon}\diff t' < 0,
	\end{align*}
	which is a contradiction to $h^*$ being a solution to \eqref{eq:QVI-SCDE}.
\end{proof}

\begin{remark}
	To see why we need \cref{ass:closedSpace} in the statement of \Cref{thm:VI-fixed-inflow:sufficient} consider again the \setS{} $S_1$ from \Cref{obs:ClosedSpaceTimeConvex} and define $$A_{p}(h^1) \coloneqq \set{(q,J,\abs{J},0) | J \in \mathcal{M}([0,2])}.$$ Then we have $T(S_1,A_p,h^1) = \set{0}$ and, thus, $h^1$ is a solution to \eqref{eq:QVI-SCDE} (regardless of the choice of \effWalkDelay{} operators) while it is not necessarily a \SCDE{} as we have $U_{p}(h^1,t) = \set{(p,0),(q,0)}$ for all $t \in [0,2]$ here.
\end{remark}

\begin{theorem}\label{thm:VI-fixed-inflow:nessecary}
	Let $h^* \in S$ be given such that $S$ and $(A_p)_{p \in \Pc}$ satisfy \labelcref{ass:closedTime,ass:closedSpace} at $h^*$. If $h^*$ is a \SCDE{} \wrt $S$ and $(A_p)_{p \in \Pc}$ then it is also a solution to~\eqref{eq:QVI-SCDE}.
\end{theorem}

\begin{proof}
	We show this by contradiction. So, let $h^*$ be a \SCDE{} and assume that there is some $v\in T(S,A_p,h^*)$ with $\scalar{\Psi(h^*)}{v} < 0$.
	By continuity of $\scalar{.}{.}$, there exist $h^n\in M(h^*)$ and $t_n>0$ such that
	\[ \scalar{\Psi(h^*)}{\frac{h^n-h^*}{t_n}}<0  \text{ or,equivalently, } \scalar{\Psi(h^*)}{h^n-h^*}<0.\]
	Rewriting and using that $h^n$ is of the form~\eqref{eq:H-r}, \ie $h^n = H^r_{p \to q}(h^*,J,\varepsilon,\Delta)$ for some $(q,J,\varepsilon,\Delta) \in A_{p}(h^*)$, yields
	\begin{align*}
		&0 > \scalar{\Psi(h^*)}{h^n-h^*}
			= \int_J \Psi_p(h^*,t)  (h_p^n(t)-h_p^*(t)) \diff t + \int_{J+\Delta}\Psi_q(h^*,t) (h_q^*(t)-h_q^n(t)) \diff t  \\
		&\quad\quad= \int_J \Psi_p(h^*,t)  (h_p^n(t)-h_p^*(t)) + \Psi_q(h^*,t+\Delta) (h_q^*(t+\Delta)-h_q^n(t+\Delta)) \diff t  \\
		&\quad\quad= \int_J \left(\Psi_q(h^*,t+\Delta)- \Psi_p(h^*,t)\right) \cdot \min\set{h^*_p(t),\varepsilon} \diff t.
	\end{align*}
	This implies that there is some subset $J' \subseteq J$ of positive measure with 
		\[\left(\Psi_q(h^*,t+\Delta)- \Psi_p(h^*,t)\right) \cdot \min\set{h^*_p(t),\varepsilon} < 0 \text{ for all } t \in J'.\]
	Since $\min\set{h^*_p(t),\varepsilon}$ is non-negative, this implies $\Psi_q(h^*,t+\Delta) < \Psi_p(h^*,t)$ for 
	all $t \in J'$. As $J'$ has positive measure, it must contain a point $t \in J'$ such that the intersection of any neighbourhood of $t$ with $J'$ also has positive measure. Defining $J_n \coloneqq [t-\frac{1}{n},t+\frac{1}{n}] \cap J'$ then results in a sequence of subsets of $J'$ of positive measure satisfying $\liminf_n J_n = \limsup_n J_n = t$. Since we have both $H_{p\to q}(h^*,J,\varepsilon,\Delta) \in M_i(h^*)$ and $J_n \subseteq J$, \cref{ass:closedTime,ass:closedSpace} ensure that $H^r_{p \to q}(h^*,J_n,\frac{\varepsilon}{n},\Delta) \in M(h^*)$ holds for all $n \in \INs$ as well. Furthermore, we have $\int_{J_n}h^*_p(t')\diff t' > 0$ for all $n$ since $h^*_p(t') > 0$ for all $t' \in J'$ and $J_n$ has positive measure. Altogether, this shows that $h^*$ is not a \SCDE{} by \Cref{lemma:NegativeCharacterization}.
\end{proof}

\begin{remark}
	To see why we need \cref{ass:closedTime} in the statement of \Cref{thm:VI-fixed-inflow:nessecary}, consider again the \setS{} $S_2$ from \Cref{obs:ClosedSpaceTimeConvex} and define the set of \addmEpsDev s $A_{p}(h^1) \coloneqq \set{(q,[0,2],\varepsilon,0) | \varepsilon \geq 0} \cup \set{(p,J,\varepsilon,0) | J \in \mathcal{M}([0,2]), \varepsilon \geq 0}$ as in the observation. Clearly, this set $A_{p}(h^1)$  is not closed under time restriction. Furthermore, we have $U_{p}(h^1,t) = \set{(p,0)}$ for all $t \in [0,2]$ and, therefore, $h^1$ is a \SCDE. However, it is also easy to see that for certain choices of the \effWalkDelay{} operators $\Psi_p$ and $\Psi_q$ the flow $h^1$ is not a solution to the quasi-variational inequality \eqref{eq:QVI-SCDE} (\eg choose constant flow independent delays $\Psi_p \equiv 2$ and $\Psi_q \equiv 1$).
\end{remark}


\subsection{Variational Inequality}

Quasi-variational inequalities may be much harder to solve compared to standard variational inequalities since the feasible search space depends on the  solution itself. However, under an additional assumption, we can also use the following variational inequality to characterize \SCDE{}:
\begin{equation}\label{eq:VI-SCDE}\tag{\ensuremath{\VI(\Psi,S)}}
	\begin{aligned}
		\text{Find }h^* \in  S  \text{ such that}:&\\
		\scalar{\Psi(h^*)}{h-h^*} &\geq 0 \text{ for all }h \in S.
	\end{aligned}
\end{equation}
Note, that this variational inequality is of exactly the form of~\eqref{eq:ZhongVI} used by \citefulls{zhong11} to define their version of side-constrained dynamic equilibria.

For the sufficiency part, we need the following additional assumption stating that small enough \addmEpsDev s from a feasible flow lead to another feasible flow:
\begin{enumerate}[label=(A\arabic*),resume=Assumptions]
	\item For any $h \in S$ there exists some neighbourhood $V_h$ of $h$ such that $M(h) \cap V_h \subseteq S$.\label[asmpt]{ass:addmDevLeadToFeasFlow}
\end{enumerate}
Note that this assumption is trivially satisfied for \globalSCDE{} as, in this case, by definition any \addmEpsDev{} leads to a feasible flow.

\begin{theorem}\label{thm:VI-sufficient}
	Take any constraint set $S$ and \addmEpsDev s $(A_p)_{p \in \Pc}$ satisfying \labelcref{ass:closedSpace,ass:addmDevLeadToFeasFlow}. Furthermore, assume that $\Psi$ satisfies \ref{ass:EffectivePathDelayContinuous}.
	Then, any solution $h^*$ to the variational inequality~\eqref{eq:VI-SCDE} is a \SCDE{} \wrt $S$ and $(A_p)_{p \in \Pc}$.
\end{theorem}

\begin{proof}
	Let $h^* \in S$ be a solution to the variational inequality~\eqref{eq:VI-SCDE}. We claim that $h^*$ is then also a solution to the quasi-variational inequality~\eqref{eq:QVI-SCDE}. In order to show this, take any $v \in T(S,A_p,h^*)$. Then there exist sequences of $(h^n)_{n \in \IN} \subset M(h^*)$ and $(t_n)_{n \in \IN} \subset \IR_{>0}$ such that $\lim_{n\rightarrow\infty}\frac{h^n-h^*}{t_n} = v$. Using the continuity of $\scalar{.}{.}$, we get
	\begin{align*}
		\scalar{\Psi(h^*)}{v} = \scalar{\Psi(h^*)}{ \lim_{n\rightarrow\infty}\frac{h^n-h^*}{t_n}} =  \lim_{n\rightarrow\infty}\frac{1}{t_n}\scalar{\Psi(h^*)}{h^n-h^*} \geq 0.
	\end{align*}
	The last inequality holds since $h^n \in M(h)$ implies $h^n \in S$ for large enough $n$ due to \ref{ass:addmDevLeadToFeasFlow} and since $h^*$ is a solution to \eqref{eq:VI-SCDE}. Thus, we can now apply \Cref{thm:VI-fixed-inflow:sufficient} to conclude that $h^*$ is indeed a \SCDE.
\end{proof}

Now, whenever in addition to the assumptions of \Cref{thm:VI-sufficient} we know that \eqref{eq:VI-SCDE} has a solution, we get a first existence result for \SCDE{} generalizing the existence theorem for unconstrained dynamic equilibria (\Cref{thm:ExistenceUnconstrained}):

\begin{corollary}
	Let $S$ be a convex, non-empty, closed and bounded set and $A_p$ satisfying \labelcref{ass:closedSpace,ass:addmDevLeadToFeasFlow}. Furthermore, assume that \ref{ass:FinitelyManyWalks} holds and $\Psi$ satisfies \labelcref{ass:PsiBounded,ass:EffectivePathDelayContinuous,ass:PsiWScont}. Then there exists a \SCDE{} \wrt $S$ and $A_p$.
\end{corollary}

\begin{proof}
	By \Cref{thm:Lions} the variational inequality \eqref{eq:VI-SCDE} has a solution which, by \Cref{thm:VI-sufficient}, is a \SCDE.
\end{proof}

\begin{remark}
	Note that for \globalSCDE{} assumption \ref{ass:addmDevLeadToFeasFlow} holds automatically and \ref{ass:closedSpace} follows from the convexity of $S$. In particular the existence result for capacitated dynamic equilibria in \cite[Theorem 6]{GHP22} is a special case of the above corollary.
	
	On the other hand, the counterexamples from \Cref{sec:counter} also show that \cref{ass:closedSpace} does not necessarily hold for \globalSCDE{} with $S$ defined by volume-constraints. Thus, even in cases where the variational inequality~\eqref{eq:VI-SCDE} has a solution, it is not clear whether such a solution is also a \SCDE.
\end{remark}

For the necessity part we only consider the case of fixed network inflow rates and require the following additional property of the constraint set $S$ and the \addmEpsDev s~$A_p$.

\begin{definition}\label{def:elementary}
	The set $S \subseteq \Lambda(r)$ is called \emph{closed with respect to elementary directions}, 
	if for all $h,h'\in S$ the following holds true:
	Whenever there exist $i\in I, p,q\in \Pc_i$ and $J \subset \planningInterval$ with positive measure such that $h_p(t) - h'_p(t) > 0$ and $h'_q(t) - h_q(t) > 0$
	for all $t\in J$, we have $(q,0) \in U_{p}(h,t)$ for some $t \in J$.
\end{definition}

This property states that in any walk inflow $h \in S$ particles are allowed to switch from some walk $p$ to another walk $q$ if there exists another feasible walk inflow $h'$ which has a lower inflow rate into $p$ and (during the same time) a higher inflow rate into $q$. 

\begin{theorem}\label{thm:VI-necessary}
	Take any constraint set $S \subseteq \Lambda(r)$ with fixed inflow rates and \addmEpsDev s $(A_p)_{p \in \Pc}$ such that $S$ is closed with respect to elementary directions. Then, every \SCDE{} $h^*\in S$ \wrt $S$ and $(A_p)_{p \in \Pc}$ is a solution to the variational inequality~\eqref{eq:VI-SCDE}.
\end{theorem}

\begin{proof}
	Let $h^* \in S$ be a \SCDE. We have to show that $h^*$ is a solution to~\eqref{eq:VI-SCDE}, \ie that for any $h\in S$ we have $\scalar{\Psi(h^*)}{h-h^*} \geq 0$. So, assume for contradiction that this is not the case, \ie there exists some $h \in S$ with $\scalar{\Psi(h^*)}{h-h^*} < 0$.
	
	We now define for any pair of walks $p$ and $q$ a function $g_{p \to q}: \planningInterval \to \IR_{\geq 0}$ by 
	\begin{align*}
		g_{p \to q}(t) \coloneqq \begin{cases}
			\left(h_p(t)-h^*_p(t)\right)\cdot\frac{h^*_q(t)-h_q(t)}{\sum_{\substack{q' \in \Pc:\\ h_{q'}(t) < h^*_{q'}(t)}}\left(h^*_{q'}(t)-h_{q'}(t)\right)}, &\text{ if } h_p(t) > h^*_p(t), h_q(t) < h^*_q(t) \\
			0,												&\text{ else }.
		\end{cases}
	\end{align*}
	First, we observe that these functions are non-negative, bounded, well-defined and measurable. Now we define for each of these functions a corresponding function $h_{p \to q} \in L^2(\planningInterval)^\Pc$ by setting
	\begin{equation}
		(h_{p\rightarrow q})_w(t) \coloneqq 
		\begin{cases} 
			0, 								&\text{ if }w\not\in \{p,q\}\\
			g_{p\rightarrow q}(t)\in \R_+, 	&\text{ if }w=p\\
			-g_{p\rightarrow q}(t)\in \R_-, &\text{ if }w=q.
		\end{cases}
	\end{equation}
	We now claim that these functions add up to precisely the difference between $h$ and $h^*$:
	
	\begin{claim}\label{claim:TranshipmentSolution}
		We have $h-h^* = \sum_{p,q \in \Pc}h_{p\to q}$.
	\end{claim}
	
	\begin{proofClaim}
		Let $w \in \Pc$ be any walk and $t \in \planningInterval$ be any time. Then, we distinguish three cases:
		\begin{description}
			\item[Case 1 ($h_w(t) = h^*_w(t)$):] In this case, we have $g_{p \to w}(t) = 0 = g_{w \to q}(0)$ for all $p, q \in \Pc$ and, thus,
			\begin{align*}
				\left(\sum_{p,q \in \Pc}h_{p\to q}\right)_w 
				&= \left(\sum_{p \in \Pc}h_{p\to w}\right)_w + \left(\sum_{q \in \Pc}h_{w\to q}\right)_w \\
				&= \sum_{p \in \Pc}-g_{p\to w} + \sum_{q \in \Pc}g_{w\to q} = 0 = (h_w(t) - h^*_w(t)).\\
			\end{align*}
			
			\item[Case 2 ($h_w(t) > h^*_w(t)$):] In this case, we have $g_{p \to w}(t) = 0$ for all $p \in \Pc$ and $g_{w \to q}(t) = 0$ for all $q \in \Pc$ with $h_q(t) \geq h^*_q(t)$. For all other $q$, we have $g_{w \to q}(t) = \left(h_w(t)-h^*_w(t)\right)\cdot\frac{h^*_q(t)-h_q(t)}{\sum_{q' \in \Pc: h_{q'}(t) < h^*_{q'}(t)}\left(h^*_{q'}(t)-h_{q'}(t)\right)}$ and, thus,
			\begin{align*}
				\left(\sum_{p,q \in \Pc}h_{p\to q}\right)_w 
				&= \sum_{p \in \Pc}-g_{p\to w} + \sum_{q \in \Pc}g_{w\to q} \\
				&= 0 + \sum_{\substack{q \in \Pc:\\ h_q(t) < h^*_q(t)}}\left(h_w(t)-h^*_w(t)\right)\cdot\frac{h^*_q(t)-h_q(t)}{\sum_{q' \in \Pc: h_{q'}(t) < h^*_{q'}(t)}\left(h^*_{q'}(t)-h_{q'}(t)\right)} \\
				&= h_w(t)-h^*_w(t).
			\end{align*}
			Note, that we need fixed inflow rates (\ie $S \subseteq \Lambda(r)$) here to ensure that there exists at least one walk $q$ with $h_q(t)-h^*_q(t)$. This is used in the last equality.
			
			\item[Case 3 ($h_w(t) < h^*_w(t)$):] In this case, we have $g_{w \to q}(t) = 0$ for all $q \in \Pc$ and $g_{p \to w}(t) = 0$ for all $p \in \Pc$ with $h_p(t) \leq h^*_p(t)$. For all other $p$, we have $g_{p \to w}(t) = \left(h_p(t)-h^*_p(t)\right)\cdot\frac{h^*_w(t)-h_w(t)}{\sum_{q' \in \Pc: h_{q'}(t) < h^*_{q'}(t)}\left(h^*_{q'}(t)-h_{q'}(t)\right)}$ and, thus,
			\begin{align*}
				\left(\sum_{p,q \in \Pc}h_{p\to q}\right)_w 
				&= \sum_{p \in \Pc}-g_{p\to w} + \sum_{q \in \Pc}g_{w\to q}& \\
				&= -\sum_{\mathclap{\substack{p \in \Pc:\\ h_p(t) > h^*_p(t)}}}\left(h_p(t)-h^*_p(t)\right)\cdot\frac{h^*_w(t)-h_w(t)}{\sum_{q' \in \Pc: h_{q'}(t) < h^*_{q'}(t)}\left(h^*_{q'}(t)-h_{q'}(t)\right)} + 0& \\
				&= -\left(h^*_w(t)-h_w(t)\right). &\qedhere
			\end{align*}
		\end{description}
	\end{proofClaim}
	
	Now, using our initial assumption $\scalar{\Psi(h^*)}{h-h^*} < 0$, we get
	\begin{align*}
		0 &> \scalar{\Psi(h^*)}{h-h^*} 
		\overset{\text{\Cref{claim:TranshipmentSolution}}}{=} \scalar{\Psi(h^*)}{\sum_{p,q\in \Pc}h_{p\rightarrow q}}\\
		&=\sum_{p,q\in \Pc} \scalar{\Psi(h^*)}{h_{p\rightarrow q}}
		=\sum_{p,q\in \Pc}\sum_{w \in \Pc} \int_{\tStart}^{\tEnd} \Psi_w(h^*,t)\cdot (h_{p\rightarrow q})_w(t) dt \\
		&= \sum_{p,q\in \Pc} \int_{\tStart}^{\tEnd} \Psi_p(h^*,t)\cdot g_{p\rightarrow q}(t) dt + \int_{\tStart}^{\tEnd} \Psi_q(h^*,t)\cdot (-g_{p\rightarrow q}(t)) dt \\
		&= \sum_{p,q\in \Pc} \int_{\tStart}^{\tEnd}g_{p\rightarrow q}(t) (\Psi_p(h^*,t)-\Psi_q(h^*,t))\diff t.
	\end{align*}
	Since  $g_{p\rightarrow q}\geq 0$, there must be a subset $J\subset \planningInterval$ of positive measure
	with $g_{p\rightarrow q}(t)>0 $ and $\Psi_p(h^*,t)-\Psi_q(h^*,t)<0$ for all $t\in J$. 	
	As $g_{p\rightarrow q}(t)>0 $ implies $h^*_p(t)-h_p(t)<0$ and $h^*_q(t)-h_q(t)>0$ and $S$ is  closed with respect to elementary directions, we get $(p,0) \in U_{q}(h^*,t)$ for some time $t\in J$ which, together with $\Psi_p(h^*,t)-\Psi_q(h^*,t)<0$, contradicts that $h^*$ is a \SCDE.
\end{proof}

\begin{obs}
	For any fixed time $t \in \planningInterval$ the values $g_{p\rightarrow q}(t), p,q\in \Pc$ defined in the proof above solve a transshipment problem defined as follows:
	We create a complete bipartite graph $G=(V_1(t)\cup V_2(t), E(t))$,
	where nodes in $V_1(t) \subseteq \Pc$ are surplus nodes, that is, 
	they fulfil $b_p(t):=h_p(t)-h^*_p(t)>0$, and nodes in $ V_2(t)\subseteq \Pc$
	are deficit nodes fulfilling $b_q(t):=h_q(t)-h^*_q(t)<0$.
	Note that obviously $V_1(t)\cap V_2(t)=\emptyset$ for all $t\in \planningInterval$.
	For every arc $(p,q)\in E(t):=V_1(t)\times V_2(t)$ we define
	capacities $c_{(p,q)}(t):=\min\{b_p(t), b_q(t)\}$.
\end{obs}

\begin{remark}
	Clearly $S=\Lambda(r)$ and $A_p$ defined by \eqref{eq:ApglobalSCDE} also satisfy the assumptions of \Cref{thm:VI-necessary}. Thus, \Cref{thm:VI-sufficient,thm:VI-necessary} together are a generalization of the characterization of unconstrained dynamic equilibria with fixed inflow rates by variational inequalities (\ie \Cref{thm:VICharOfDE}).
\end{remark}

Another interesting example for which \Cref{def:elementary} applies is the case of monotone box-constraints.
\begin{example}
	Consider continuous and non-decreasing functions $z_p:\R_+\rightarrow\R_+, p\in\Pc$ and continuous functions 	$v_p:\planningInterval\rightarrow\R_+, p\in\Pc$.
	We get that the set
		\[ S:=\Set{ h\in \Lambda(r) | z_p(h_p(t)) \leq v_p(t) \text{ for all } p\in\Pc \text{ and almost all } t \in \planningInterval}\]
	is closed with respect to elementary directions.
	To see this, let $h,h'\in S$ with $h_p(t)-h'_p(t) > 0$ and $h'_q(t)-h_q(t) > 0$
	for all $t\in J$, where $J$ is some set of positive measure. 
	
	Then, there must also exist some $\varepsilon > 0$ and a subset $J' \subseteq J$ of positive measure with $h_p(t)-h'_p(t) \geq \varepsilon$ and $h'_q(t)-h_q(t) \geq \varepsilon$ for all $t \in J'$. We can then construct a sequence of sets $J_n \subseteq J'$ of positive measure satisfying $J_{n+1} \subseteq J_n$ and $\lim_n \inf J_n = \lim_n \sup J_n = t$ for some $t \in J'$.	
	Then, for any $n \in \INs$ we have
		\[ H^r_{p \to q}(h,J_n,\tfrac{\varepsilon}{n},0)_w(t) \leq \max\set{h_w(t),h'_w(t)}\]
	for all $t \in J_n$ and $w\in \Pc$. Since both $h$ and $h'$ are from $S$ this then implies
		\begin{align*}
			&z_w\left(H^r_{p \to q}(h,J_n,\tfrac{\varepsilon}{n},0)_w(t)\right) \leq z_w\left(\max\set{h_w(t),h'_w(t)}\right) \\
			&\quad\quad\quad= \max\set{z_w(h_w(t)),z_w(h'_w(t))} \leq v_w(t)
		\end{align*}
	for almost all $t \in J_n$ and, thus, $H^r_{p \to q}(h,J_n,\frac{\varepsilon}{n},0) \in S$. Since $\int_{J_n}\min\set{h_p(t'),\frac{\varepsilon}{n}}\diff t' = \int_{J_n}\frac{\varepsilon}{n}\diff t' > 0$ and $t \in [\inf J_n,\sup J_n]$ hold as well, this is enough to show $(q,0) \in U_{p}(h,t)$.
\end{example}