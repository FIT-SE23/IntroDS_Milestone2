% !TeX spellcheck = en_GB
%!TEX root = ../side-constrained.tex

\section{Volume Constraints and Network-Loading}\label{sec:SCviaNL}

In this section, we will now come back to more concrete \SCDE[fulls], where flows are feasible whenever they obey certain ``capacity constraints'' on the edges of the network. We will only consider the case of fixed flow volume (and free departure time choice) here but note that all definitions and results can be easily transferred to the case of fixed network inflow rates by choosing $S \cap \Lambda(r)$ instead of the sets $S$ defined here and only allowing \addmEpsDev s with $\Delta=0$.

In order to formally define \SCDE{} with capacity constraints, will assume that for every edge $e$, we are given  a capacity function $c_e: \IR_{\geq 0} \to \IR_{\geq 0}$ and that the flow model is equipped with a weak form of network-loading associating with every walk inflow $h$ two types of functions:
\begin{itemize}
	\item \emph{Arrival time} functions $\tau^j_p(h,.): [t_0,t_f] \to \IR_{\geq 0}$ such that for every time $t \in \planningInterval$, walk $p =(v_1,v_2,\dots,v_{\abs{p}+1}) \in \Pc$ and $j \in \set{1,\dots,\abs{p}+1}$, the value $\tau^j_p(h,t)$ denotes the time at which a particle entering walk $p$ at time $t$ will arrive at the $j$-th node on walk $p$ (or, equivalently leaves the $(j-1)$-th edge/enters the $j$-th edge of walk $p$). In particular, $\tau^1_p(h,t)$ denotes the time at which a particle starts its journey and  $\tau^{\abs{p}+1}_p(h,t)$ denotes the time at which the particle arrives at the end of walk $p$ (i.e. the sink).
	\item \emph{Edge-load} functions $f_e(h,.): \IR_{\geq 0} \to \IR_{\geq 0}$ such that for every edge $e$ and time $t \in \IR_{\geq 0}$, the value $f_e(h,t)$ denotes some measure of the flow induced by $h$ on edge $e$ at time~$t$ and which, in a feasible flow, has to be bounded by the edge capacity $c_e(t)$. 
\end{itemize}

\begin{remark}
	Given a model with a full network-loading (as described in \Cref{sec:counter}), the arrival time functions could be defined using the corresponding walk-delay functions $D_p$, i.e.
		\[\tau_p^j(h,t) \coloneqq t + D_{p|_{j-1}}(h,t),\]
	where $p|_{j-1}$ is the prefix of $p$ of length $j-1$. The edge-load function could then, for example, be the flow volume $\flowVolume[e](h,t)$, the queue length $q_e(h,t)$, the cumulative inflow $\int_0^t f^+_e(\theta)\diff\theta$ or the current inflow rate $f^+_e(t)$
\end{remark}

We now define the set of all walk inflows resulting in network flows obeying these edge capacities by
\begin{align}\label{eq:FeasibilitySetforEdgeLoad}
	S \coloneqq \Set{h \in \Lambda(Q) | f_e(h,t) \leq c_e(t) \text{ f.a. } t \in \IR_{\geq 0}}.
\end{align}
Using this\setS{} in order to define a \globalSCDE{} (cf. \Cref{def:strongCDE}) results in an equilibrium that we call \emph{\globalEL[full] (\globalEL)}. 
%If $f_e$ denotes the flow volume on edge $e$, this equilibrium concept is the one Zhong et al. seemed %to have in mind with their definition of side-constrained equilbria in \cite{zhong11}. 
Since, as discussed in \Cref{sec:counter}, the \setS{} defined by \eqref{eq:FeasibilitySetforEdgeLoad} need not be convex, we can, in general, not use the corresponding variational inequality~\eqref{eq:VI-SCDE} to characterize those types of equilibria. Furthermore, the admissible deviations need not even satisfy \ref{ass:closedTime} or \ref{ass:closedSpace} (see \Cref{ex:NonConvexitOfEdgeLoadConstraints}), so we also can not apply the quasi-variational inequality.
Another problem of \globalEL{} is that this definition is rather restrictive in what counts as an \addmEpsDev{} (and, in turn, leads to a rather weak type of equilibrium). Namely, particles are only allowed to deviate, if their deviation leads to a new flow which is again feasible for \emph{all} particles -- in particular also for the particles which are not themselves involved in the deviation. In \Cref{ex:DifferenceBetweenLocalAndGlobalFeas}, we provide an instance with a \globalSCDE{} in which particles seem to have a better alternative to their current route choice but are not allowed to deviate because that would lead to infeasibility for \emph{other} particles not involved in the deviation. 

\subsection{Dynamic Equilibria of Type LP, BS and MNS}
In the following,  we want to allow for deviations in which the deviating particles themselves will not violate the capacity constraints while ignoring potential violations by particles not directly involved in the deviation. To formalize this in terms of \addmEpsDev s, we need to answer two questions: At which (time) points during its potential alternative journey must a particle check whether it would violate some capacity constraint and how does a particle check whether it would violate a capacity constraint? For the first question we will consider two potential answers 
\begin{enumerate}[label=\alph*)]
	\item Whenever it enters a new edge, i.e. at all points $\tau^j_q(h,t)$ for $j = 1, \dots, \abs{q}$ or
	\item Whenever a particle travels along an edge, i.e. at all point $\theta \in [\tau^j_q(h,t),\tau^{j+1}_q(h,t)]$ for $j = 1, \dots, \abs{q}$. 
\end{enumerate}
Since a) clearly allows more deviations then b), we will call equilibria using a) \emph{strong} and equilibria using b) \emph{weak}. For the second question we will propose three different answers. First, we can follow the approach of Larsson and Patriksson in the static model (cf. \Cref{def:weakWE}) and require that alternative walks are truly unsaturated at the time of deviation. In other words, at any time at which a deviating particle would arrive at an edge/travel along an edge of the alternative walk (according to the travel times of the current flow), there must be some additional room left on this edge (i.e., $f_e < c_e$ must hold). We can formalize this by
\begin{align}\label{eq:FeasibleDeviationsAlwaysAdditionalSpaceEnter}
	A_{p}(h) \coloneqq \Set{(q,J,\varepsilon,\Delta) | \forall t \in J+\Delta, e = (v_j,v_{j+1}) \in q: f_e(h,\tau^j_{q}(h,t)) < c_e(\tau^j_{q}(h,t)))}
\end{align}
and
\begin{align}\label{eq:FeasibleDeviationsAlwaysAdditionalSpaceTravelling}
	A_{p}(h) \coloneqq \Set{(q,J,\varepsilon,\Delta) | \begin{array}{l}
			\forall e = (v_j,v_{j+1}) \in q, t \in J+\Delta: \\
			f_e(h,\theta) < c_e(\theta) \text{ f.a. } \theta \in [\tau^j_q(h,t),\tau^{j+1}_q(h,t)]
		\end{array}}.
\end{align}
We call the resulting equilibrium a \emph{\sCDEu[full] (\sCDEu)} or a  \emph{\wCDEu[full] (\wCDEu)}, respectively. While this equilibrium notion seems quite intuitive, it has the same drawback as noted by Marcotte et al. for LP-equilibria in the static model: Namely, one can consider a network consisting of two paths of different length that share their first edge. Then, a flow which only sends flow over the longer path can still be an equilibrium if this flow completely uses the available capacity on the shared first edge. 

A more lenient definition, thus, would allow $f_e \leq c_e$ to be tight on any common prefix of $p$ and $q$, i.e. 
\begin{align}\label{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixEnter}
	A_{p}(h) &\coloneqq \Set{(q,J,\varepsilon,0) | \begin{array}{l}
			\exists \text{ a common prefix } w \text{ of } p \text{ and } q \text{ with } q = w\tilde{q} \text{ and} \\
			\forall t \in J, e = (v_j,v_{j+1}) \in \tilde{q}: f_e(h,\tau^j_{q}(h,t)) < c_e(\tau^j_{q}(h,t)))
	\end{array}} \\
	& \cup \Set{(q,J,\varepsilon,\Delta) | \begin{array}{l}
			\forall t \in J+\Delta, e = (v_j,v_{j+1}) \in q: f_e(h,\tau^j_{q}(h,t)) < c_e(\tau^j_{q}(h,t)))
	\end{array}}\notag
\end{align}
and 
\begin{align}
	A_{p}(h) &\coloneqq \Set{(q,J,\varepsilon,0) | \begin{array}{l}
			\exists \text{ a common prefix } w \text{ of } p \text{ and } q \text{ with } q = w\tilde{q} \text{ and} \\
			\forall t \in J, e = (v_j,v_{j+1}) \in \tilde{q}, \theta \in [\tau^j_q(h,t),\tau^{j+1}_q(h,t)]: f_e(h,\theta) < c_e(\theta)
	\end{array}\!\!\!\!\!} \notag\\
	& \cup \Set{(q,J,\varepsilon,\Delta) | \begin{array}{l}
			\forall t \in J+\Delta, e = (v_j,v_{j+1}) \in q: \\ f_e(h,\theta) < c_e(\theta) \text{ for all } \theta \in [\tau^j_q(h,t),\tau^{j+1}_q(h,t)]
	\end{array}}\label{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixTravelling}
\end{align}
Here, $w\tilde{q}$ denotes the walk obtained by concatenating the walks $w$ and $\tilde{q}$. As this definition is inspired by the drawbacks of the LP-equilibrium noted by Marcotte et al., we call the resulting equilibrium a \emph{\sCDEuP[full] (\sCDEuP)} and a \emph{\wCDEuP[full] (\wCDEuP)}, respectively.

Finally, we can also require  -- similarly to the \BS-equilibrium from the static model -- that  the new flow (obtained after a potential deviation) must satisfy the capacity constraints at all points relevant for the deviating particles. This is formalized in the following two types of \addmDev s:
\begin{align}\label{eq:UnsaturatedPathsFeasibleAfterDeviationEnter}
	A_{p}(h) \coloneqq \Set{(q,J,\varepsilon,\Delta) | \begin{array}{l}
				\text { f.a. } e = (v_j,v_{j+1}) \in q, t \in J+\Delta, h' = H_{p \to q}(h,J,\varepsilon,\Delta): \\ 	
				f_e(h',\tau_q^j(h',t)) \leq c_e(\tau_q^j(h',t))
			\end{array}\!\!\!}
\end{align}
and
\begin{align}\label{eq:UnsaturatedPathsFeasibleAfterDeviationTravelling}
	A_{p}(h) \coloneqq \Set{(q,J,\varepsilon,\Delta) | \begin{array}{l}
				\text { f.a. } e = (v_j,v_{j+1}) \in q, t \in J+\Delta, h' = H_{p \to q}(h,J,\varepsilon,\Delta): \\
				\theta \in [\tau^j_q(h',t),\tau^{j+1}_q(h',t)]: f_e(h',\theta) \leq c_e(\theta) 
			\end{array}\!\!\!}
\end{align}
We call this type of equilibrium a \emph{\sCDEdf[full] (\sCDEdf)} or a \emph{\wCDEdf[full] (\wCDEdf)}, respectively, as the \BS[full] in the static model also requires that the costs cannot decrease by switching to any other path whenever such a switch would result in another feasible (static) flow (cf. \Cref{def:BS}). Note, however, that in the static model, feasibility for the particles involved in the deviation typically (if the cost functions are separable and nondecreasing) also ensures feasibility for all other particles -- thus, the difference between \globalEL{} and \sCDEdf{}/\wCDEdf{} vanishes there, whereas \globalEL{} are strictly weaker than both \sCDEdf{} and \wCDEdf{} in the dynamic setting.

The following definition summarizes all the different types of equilibria defined in this section:
\begin{defn}\label{def:TypesOfCDE}
	Let the \setS{} $S$ be defined in \eqref{eq:FeasibilitySetforEdgeLoad}. Then, a side-constrained dynamic equilibrium is 
	\begin{itemize}
		\item a \emph{\globalEL[full] (\globalEL)} if the \addmEpsDev{}s are defined by \eqref{eq:ApglobalSCDE},
		\item a \emph{\sCDEu[full] (\sCDEu)} if the \addmEpsDev{}s are defined by \eqref{eq:FeasibleDeviationsAlwaysAdditionalSpaceEnter},
		\item a \emph{\wCDEu[full] (\wCDEu)} if the \addmEpsDev{}s are defined by \eqref{eq:FeasibleDeviationsAlwaysAdditionalSpaceTravelling},
		\item a \emph{\sCDEuP[full] (\sCDEuP)} if the \addmEpsDev{}s are defined by \eqref{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixEnter} and
		\item a \emph{\wCDEuP[full] (\wCDEuP)} if the \addmEpsDev{}s are defined by \eqref{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixTravelling},
		\item a \emph{\sCDEdf[full] (\sCDEdf)} if the \addmEpsDev{}s are defined by \eqref{eq:UnsaturatedPathsFeasibleAfterDeviationEnter},
		\item a \emph{\wCDEdf[full] (\wCDEdf)} if the \addmEpsDev{}s are defined by \eqref{eq:UnsaturatedPathsFeasibleAfterDeviationTravelling}.
	\end{itemize}
\end{defn}

The relationships between these different equilibrium concepts are captured in the following \namecref{prop:RelationshipsOfCDE}.

\begin{prop}\label{prop:RelationshipsOfCDE}
	Denoting the sets of equilibria by their respective names we have the following relations between them:
		\begin{center}
			\begin{tikzpicture}[node distance=3cm,every node/.append style={text depth=0.25ex}]
				\node(sL){\sCDEu};
				\node(wL)[right of=sL]{\wCDEu};
				\node(sM)[below of=sL, node distance=1cm]{\sCDEuP};
				\node(wM)[right of=sM]{\wCDEuP};
				
				\path(sL) --node[sloped]{$\subseteq$} (wL);
				\path(sM) --node[sloped]{$\subseteq$} (sL);
				\path(sM) --node[sloped]{$\subseteq$} (wM);
				\path(wM) --node[sloped]{$\subseteq$} (wL);
			\end{tikzpicture}
		\end{center}
	and
		\begin{center}
			\begin{tikzpicture}[node distance=3cm,every node/.append style={text depth=0.25ex}]
				\node(sB){\sCDEdf};
				\node(wB)[right of=sB]{\wCDEdf};
				\node(sC)[right of=wB]{\globalEL};
				
				\path(sB) --node[sloped]{$\subseteq$} (wB)
							--node[sloped]{$\subseteq$} (sC);
			\end{tikzpicture}
		\end{center}
	If both $f_e$ and $\tau^j_p$ depend continuously on $h$ and $f_e(h,.), \tau^j_p(h,.), c_e$ are all continuous functions then we additionally have
		\begin{center}
			\begin{tikzpicture}[node distance=5cm,every node/.append style={text depth=0.25ex}]
				\node(sL){\sCDEu};
				\node(wL)[right of=sL]{\wCDEu};
				\node(sB)[below of=sL,node distance=1cm]{\sCDEdf};
				\node(wB)[right of=sB]{\wCDEdf};
				
				\path(sB) --node[sloped]{$\subseteq$} (sL);
				\path(wB) --node[sloped]{$\subseteq$} (wL);
				\path(sB) --node{and} (wL);
			\end{tikzpicture}
		\end{center}
	Furthermore, in general, all these inclusions are proper and the concepts of \globalEL{} and \sCDEu{} are independent of each other, i.e. neither includes the other.
\end{prop}

\begin{proof}
	The inclusions in the first two diagrams all follow directly from \Cref{lemma:MoreAlternativesGiveStrongerEquilibria} by observing that the respective sets of \addmEpsDev s satisfy the opposite inclusion. E.g. \sCDEuP{} allow more \epsDev s than \sCDEu{} and, therefore, \sCDEuP{} is a stronger equilibrium concept than \sCDEu.
	
	For the inclusion \sCDEdf{} $\subseteq$ \sCDEu{}, we  cannot compare \addmEpsDev s but have to compare \addmDev s instead. That is, assume that $(q,\Delta) \in U_p(h,t)$ is an \addmDev{} according to \sCDEu. Then, due to the continuity of $f_e(h,.), \tau^j_p(h,.)$ and $c_e$, there must be some neighbourhood $V \subseteq \planningInterval$ of $t+\Delta$ such that for all $\theta \in V$ and $e=(v_j,v_{j+1}) \in q$, we have $f_e(h,\tau_q^j(h,\theta)) < c_e(\tau_q^j(h,\theta))$. Since all $f_e$ and $\tau_q^j$ also depend continuously on $h$, we then have $f_e(h^\varepsilon,\tau_q^j(h^\varepsilon,\theta)) \leq c_e(\tau_q^j(h^\varepsilon,\theta))$ for all $\theta$ in some smaller neighbourhood $V' \subseteq V$ and $h^\varepsilon \coloneqq H_{p \to q}(h,V'-\Delta,\varepsilon,\Delta)$ for small enough $\varepsilon$. This then implies $(q,V'-\Delta,\varepsilon,\Delta) \in A_p(h)$ according to \sCDEdf{} and, consequently, $(q,\Delta) \in U_p(h,t)$ according to \sCDEdf. Thus, all \addmDev s according to \sCDEu{} are \addmDev s according to \sCDEdf{} as well and, therefore, the latter is a stronger equilibrium concept than the former. The inclusion \wCDEdf{} $\subseteq$ \wCDEu{} can be shown in the same way.
	
	For the independence of \globalEL{} and \sCDEu{}, we note that the corresponding notion of \addmDev s can be both stricter for \globalEL{}  (a deviation might only be inadmissible because of infeasibility for particles not directly involved in the deviation -- see \Cref{ex:DifferenceBetweenLocalAndGlobalFeas}) and stricter for \sCDEu{}  (a deviation might still be possible even if $f_e \leq c_e$ is tight at relevant times because an increased inflow into the alternative walk $q$ does not necessarily increase $f_e$ on all of its edges). The former part also shows that there can exist \globalEL{} which are not a \sCDEdf{} while the latter part shows that there can exist \sCDEu{} which are not a \sCDEdf. %Finally, the fact that the first two inclusion can be proper has already been discussed when we introduced these equilibrium concepts.
\end{proof}

\begin{figure}[h]
	\centering
	\input{tikz/BadStrictCDE}
	%\includegraphics[width=.5\textwidth]{Images/NonExistence.pdf}
	\caption{A three commodity network with fixed network inflow rates. All values of $\tau_e$ not explicitly given in the figure are $1$ and all of $\nu_e$ not given are infinity. Using the Vickrey point queue model for the edge dynamics and the capacity constraint on edge $e$ as volume or inflow rate constraint this network has a unique feasible flow which is a \globalEL{} but neither a \wCDEdf{} nor a \wCDEu.}\label{fig:NonExistence}
\end{figure}

\begin{example}\label{ex:DifferenceBetweenLocalAndGlobalFeas}
	Consider the three commodity network with fixed network inflow rates given in \Cref{fig:NonExistence}. We use the Vikckrey point queue model for the edge dynamics and the edge capacity function of edge $e=(s_3,t_{2/3})$ as volume or inflow rate constraint. Then this network has a unique feasible flow: Commodity~$1$ sends all its flow via the direct edge towards $t_1$ and the other two commodities send all flow along their only available path. This is the only feasible flow (up to changes on a subset of measure zero) since if commodity~$1$ were to send any of its flow along the alternative path via $v$ and $s_3$, this would result in a congestion on edge $vs_3$. This, in turn, would lead to some of commodity~$2$'s particles arriving at $s_3$ after time $2$ and, thus, entering edge $e$ at the same time as the particles of commodity~$3$. This then leads to  a violation of the capacity constraint on edge~$e$.
	
	Consequently, this unique flow is a \globalEL{} (since there are no \addmDev s). However it is neither a \wCDEdf{} nor a \wCDEu{} as particles of commodity~$1$ could deviate to the shorter path without violating any capacity constraint \emph{themselves}. In particular, this network does not have any \wCDEdf{} or \wCDEu{}.
\end{example}

\begin{obs}\label{obs:CDEcharbyQVI}
	Admissible alternatives defined by either \eqref{eq:FeasibleDeviationsAlwaysAdditionalSpaceEnter}, \eqref{eq:FeasibleDeviationsAlwaysAdditionalSpaceTravelling}, \eqref{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixEnter} or \eqref{eq:FeasibleDeviationsAdditionalSpaceExceptCommonPrefixTravelling} clearly satisfy both \labelcref{ass:closedSpace,ass:closedTime}. Thus, \sCDEu, \wCDEu, \sCDEuP{} and \wCDEuP{} with continuous \effWalkDelay s (i.e. satisfying \cref{ass:EffectivePathDelayContinuous}) are all characterized by their corresponding quasi-variational inequality \eqref{eq:QVI-SCDE} (cf. \Cref{thm:VI-fixed-inflow:nessecary,thm:VI-fixed-inflow:sufficient}).
\end{obs}